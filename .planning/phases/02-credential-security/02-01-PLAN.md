---
phase: 02-credential-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - database/db_config.py
  - lineage-api/python_server.py
  - database/test_credential_validation.py
autonomous: true

must_haves:
  truths:
    - "Application exits with error code 1 when TERADATA_PASSWORD (or TD_PASSWORD) is not set"
    - "Error message clearly lists which environment variables are missing"
    - "No hardcoded default passwords exist in source code"
    - "Application starts successfully when required credentials are provided"
  artifacts:
    - path: "database/db_config.py"
      provides: "Credential validation with fail-fast at import"
      contains: "sys.exit(1)"
    - path: "lineage-api/python_server.py"
      provides: "Server startup validation"
      contains: "validate_required_credentials"
    - path: "database/test_credential_validation.py"
      provides: "Tests for credential validation behavior"
      contains: "test_missing_password"
  key_links:
    - from: "database/db_config.py"
      to: "module import"
      via: "validate_required_credentials() called at module load"
      pattern: "validate_required_credentials\\(\\)"
    - from: "lineage-api/python_server.py"
      to: "startup"
      via: "validation before Flask app runs"
      pattern: "validate_required_credentials\\(\\)"
---

<objective>
Remove hardcoded default credentials and implement fail-fast startup validation for credential security.

Purpose: Prevent the application from running in an insecure state with default credentials. The application must require explicit configuration and fail immediately with a clear error message if credentials are missing.

Output: Updated db_config.py and python_server.py with credential validation, plus tests verifying the fail-fast behavior.
</objective>

<execution_context>
@/Users/Daniel.Tehan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Daniel.Tehan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-credential-security/02-RESEARCH.md

# Source files to modify
@database/db_config.py
@lineage-api/python_server.py
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor db_config.py with fail-fast credential validation</name>
  <files>database/db_config.py</files>
  <action>
Refactor db_config.py to implement fail-fast credential validation:

1. Add imports at top: `import sys`

2. Define REQUIRED_CREDENTIALS as a list of tuples with (primary, fallback) variable names:
   ```python
   REQUIRED_CREDENTIALS = [
       ("TERADATA_PASSWORD", "TD_PASSWORD"),  # At least one must be set
   ]
   ```

3. Create validate_required_credentials() function:
   - Iterate through REQUIRED_CREDENTIALS
   - For each (primary, fallback) pair, check if EITHER is set and non-empty
   - Collect missing credentials (where neither primary nor fallback is set)
   - If any missing: print clear error to stderr and call sys.exit(1)
   - Error message format:
     ```
     ERROR: Missing required environment variables:
       - TERADATA_PASSWORD (or TD_PASSWORD)

     Please set these in your environment or .env file.
     See .env.example for configuration template.
     ```

4. Call validate_required_credentials() AFTER dotenv loading but BEFORE get_config()

5. Update get_config():
   - Remove default value for password: `os.environ.get("TD_PASSWORD", "password")` becomes `os.environ["TD_PASSWORD"]`
   - Keep safe defaults for host, user, database (these are non-sensitive)
   - Support TERADATA_* taking precedence over TD_* for password

6. Update module docstring to document:
   - REQUIRED: TD_PASSWORD or TERADATA_PASSWORD
   - OPTIONAL with defaults: TD_HOST, TD_USER, TD_DATABASE

IMPORTANT: Do NOT change the default host from the ClearScape test environment. Only remove the password default.
  </action>
  <verify>
1. Verify no default password in code: `grep -n "password" database/db_config.py` shows no hardcoded "password" string as a default
2. Verify validation function exists: `grep -n "validate_required_credentials" database/db_config.py`
3. Verify sys.exit is used: `grep -n "sys.exit" database/db_config.py`
  </verify>
  <done>
- db_config.py has validate_required_credentials() function that checks for password
- Function runs at module import time (after dotenv load)
- No hardcoded default password exists
- Module exits with code 1 if password is missing
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor python_server.py with fail-fast credential validation</name>
  <files>lineage-api/python_server.py</files>
  <action>
Refactor python_server.py to implement fail-fast credential validation:

1. Add import: `import sys`

2. Define REQUIRED_CREDENTIALS after dotenv loading (same pattern as db_config.py):
   ```python
   REQUIRED_CREDENTIALS = [
       ("TERADATA_PASSWORD", "TD_PASSWORD"),
   ]
   ```

3. Create validate_required_credentials() function (same implementation as db_config.py):
   - Check if either primary or fallback is set and non-empty
   - If missing: print error to stderr with clear message, call sys.exit(1)

4. Call validate_required_credentials() AFTER dotenv loading but BEFORE DB_CONFIG assignment

5. Update DB_CONFIG:
   - Remove default value for password: change `os.environ.get("TD_PASSWORD", "password")` to access without default
   - Since validation already ran, we know at least one password var is set
   - Use: `os.environ.get("TERADATA_PASSWORD") or os.environ["TD_PASSWORD"]`

6. Keep all other defaults (host, user, database) - these are non-sensitive

Note: The validation runs at module load time, which means importing this module will fail if credentials are missing. This is intentional - fail fast.
  </action>
  <verify>
1. Verify no default password: `grep -n '"password"' lineage-api/python_server.py` returns no matches (or only in comments)
2. Verify validation function: `grep -n "validate_required_credentials" lineage-api/python_server.py`
3. Verify sys.exit: `grep -n "sys.exit" lineage-api/python_server.py`
  </verify>
  <done>
- python_server.py has validate_required_credentials() function
- Function runs at module load time (before DB_CONFIG)
- No hardcoded default password exists
- Server fails to start with code 1 if password is missing
  </done>
</task>

<task type="auto">
  <name>Task 3: Create tests for credential validation</name>
  <files>database/test_credential_validation.py</files>
  <action>
Create a new test file to verify credential validation behavior using subprocess approach (recommended in research):

```python
#!/usr/bin/env python3
"""
Tests for credential validation in db_config.py and python_server.py.

These tests verify the fail-fast behavior when required credentials are missing.
Uses subprocess to test module import behavior in isolation.
"""

import subprocess
import sys
import os
import pytest


class TestDbConfigCredentialValidation:
    """Test credential validation in database/db_config.py"""

    def test_missing_password_exits_with_error(self):
        """Verify db_config exits with code 1 when password is missing."""
        # Create clean environment without password variables
        env = os.environ.copy()
        env.pop("TD_PASSWORD", None)
        env.pop("TERADATA_PASSWORD", None)

        # Run db_config import as subprocess
        result = subprocess.run(
            [sys.executable, "-c", "import db_config"],
            capture_output=True,
            text=True,
            env=env,
            cwd=os.path.dirname(os.path.abspath(__file__))
        )

        assert result.returncode == 1, f"Expected exit code 1, got {result.returncode}"
        assert "Missing required environment variables" in result.stderr
        assert "TERADATA_PASSWORD" in result.stderr or "TD_PASSWORD" in result.stderr

    def test_valid_td_password_starts_successfully(self):
        """Verify db_config loads successfully with TD_PASSWORD set."""
        env = os.environ.copy()
        env.pop("TERADATA_PASSWORD", None)  # Remove to test fallback
        env["TD_PASSWORD"] = "test_password"

        result = subprocess.run(
            [sys.executable, "-c", "import db_config; print('OK')"],
            capture_output=True,
            text=True,
            env=env,
            cwd=os.path.dirname(os.path.abspath(__file__))
        )

        assert result.returncode == 0, f"Failed with: {result.stderr}"
        assert "OK" in result.stdout

    def test_valid_teradata_password_starts_successfully(self):
        """Verify db_config loads successfully with TERADATA_PASSWORD set."""
        env = os.environ.copy()
        env.pop("TD_PASSWORD", None)  # Remove to test primary
        env["TERADATA_PASSWORD"] = "test_password"

        result = subprocess.run(
            [sys.executable, "-c", "import db_config; print('OK')"],
            capture_output=True,
            text=True,
            env=env,
            cwd=os.path.dirname(os.path.abspath(__file__))
        )

        assert result.returncode == 0, f"Failed with: {result.stderr}"
        assert "OK" in result.stdout

    def test_empty_password_exits_with_error(self):
        """Verify empty string password is treated as missing."""
        env = os.environ.copy()
        env["TD_PASSWORD"] = ""
        env["TERADATA_PASSWORD"] = ""

        result = subprocess.run(
            [sys.executable, "-c", "import db_config"],
            capture_output=True,
            text=True,
            env=env,
            cwd=os.path.dirname(os.path.abspath(__file__))
        )

        assert result.returncode == 1, f"Expected exit code 1, got {result.returncode}"
        assert "Missing required environment variables" in result.stderr


class TestPythonServerCredentialValidation:
    """Test credential validation in lineage-api/python_server.py"""

    def test_missing_password_exits_with_error(self):
        """Verify python_server exits with code 1 when password is missing."""
        env = os.environ.copy()
        env.pop("TD_PASSWORD", None)
        env.pop("TERADATA_PASSWORD", None)

        # Get path to lineage-api directory
        project_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
        server_dir = os.path.join(project_root, "lineage-api")

        result = subprocess.run(
            [sys.executable, "-c", "import python_server"],
            capture_output=True,
            text=True,
            env=env,
            cwd=server_dir
        )

        assert result.returncode == 1, f"Expected exit code 1, got {result.returncode}"
        assert "Missing required environment variables" in result.stderr

    def test_valid_password_allows_import(self):
        """Verify python_server imports successfully with password set."""
        env = os.environ.copy()
        env["TD_PASSWORD"] = "test_password"

        project_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
        server_dir = os.path.join(project_root, "lineage-api")

        # Just test import, not running the server
        result = subprocess.run(
            [sys.executable, "-c", "import python_server; print('OK')"],
            capture_output=True,
            text=True,
            env=env,
            cwd=server_dir
        )

        assert result.returncode == 0, f"Failed with: {result.stderr}"
        assert "OK" in result.stdout


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
```

This test file:
- Uses subprocess to test module import in clean environment
- Tests both db_config.py and python_server.py
- Verifies exit code 1 for missing credentials
- Verifies success with either TD_PASSWORD or TERADATA_PASSWORD
- Verifies empty string is treated as missing
  </action>
  <verify>
1. Run the tests with a valid password set:
   ```bash
   cd /Users/Daniel.Tehan/Code/lineage && TD_PASSWORD=test python -m pytest database/test_credential_validation.py -v
   ```
2. All 6 tests should pass
  </verify>
  <done>
- Test file exists at database/test_credential_validation.py
- Tests cover missing password, valid password (both variable names), empty password
- Tests cover both db_config.py and python_server.py
- All tests pass when run with valid credentials in parent environment
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **No hardcoded defaults:**
   ```bash
   # Should NOT find "password" as a default value in either file
   grep -n 'os.environ.get.*"password"' database/db_config.py lineage-api/python_server.py
   # Expected: no output (or only in comments)
   ```

2. **Validation exists in both files:**
   ```bash
   grep -l "validate_required_credentials" database/db_config.py lineage-api/python_server.py
   # Expected: both files listed
   ```

3. **Tests pass:**
   ```bash
   cd /Users/Daniel.Tehan/Code/lineage && TD_PASSWORD=test python -m pytest database/test_credential_validation.py -v
   # Expected: 6 tests pass
   ```

4. **Manual verification - db_config fails without password:**
   ```bash
   cd /Users/Daniel.Tehan/Code/lineage/database && \
   env -u TD_PASSWORD -u TERADATA_PASSWORD python -c "import db_config" 2>&1
   # Expected: Error message about missing credentials, exit code 1
   ```

5. **Manual verification - server fails without password:**
   ```bash
   cd /Users/Daniel.Tehan/Code/lineage/lineage-api && \
   env -u TD_PASSWORD -u TERADATA_PASSWORD python -c "import python_server" 2>&1
   # Expected: Error message about missing credentials, exit code 1
   ```
</verification>

<success_criteria>
- [ ] No default credentials in db_config.py (SEC-01)
- [ ] No default credentials in python_server.py (SEC-01)
- [ ] db_config.py exits with code 1 if password missing (SEC-02)
- [ ] python_server.py exits with code 1 if password missing (SEC-02)
- [ ] Error messages clearly identify which variables are missing (SEC-02)
- [ ] Both TD_PASSWORD and TERADATA_PASSWORD are accepted (backwards compat)
- [ ] Tests verify fail-fast behavior (TEST-03)
- [ ] All 6 credential validation tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-credential-security/02-01-SUMMARY.md`
</output>
