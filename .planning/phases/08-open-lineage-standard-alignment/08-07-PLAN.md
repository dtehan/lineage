---
phase: 08-open-lineage-standard-alignment
plan: 07
type: execute
wave: 5
depends_on: ["08-05", "08-06"]
files_modified:
  - docs/user_guide.md
  - CLAUDE.md
  - database/README.md
autonomous: true

must_haves:
  truths:
    - "User guide documents OpenLineage schema and v2 API endpoints"
    - "CLAUDE.md updated with OpenLineage information"
    - "Database README documents OL_* tables"
    - "Migration path from v1 to v2 API documented"
    - "OpenLineage spec version (2-0-2) is documented"
  artifacts:
    - path: "docs/user_guide.md"
      provides: "Updated user documentation"
      contains: "OpenLineage"
    - path: "CLAUDE.md"
      provides: "Updated Claude Code instructions"
      contains: "OL_"
  key_links:
    - from: "docs/user_guide.md"
      to: "OpenLineage spec"
      via: "documentation reference"
      pattern: "openlineage.io"
---

<objective>
Update documentation to reflect OpenLineage schema alignment and v2 API.

Purpose: Ensure users and developers understand the new OpenLineage-aligned schema, how to use the v2 API, and how it relates to the existing v1 API.

Output: Updated user guide, CLAUDE.md, and database README with OpenLineage documentation.
</objective>

<execution_context>
@/Users/Daniel.Tehan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Daniel.Tehan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-open-lineage-standard-alignment/08-RESEARCH.md
@docs/user_guide.md
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CLAUDE.md with OpenLineage information</name>
  <files>CLAUDE.md</files>
  <action>
Add OpenLineage schema information to CLAUDE.md. Find the "Key Teradata Tables" section and update it to include both schema versions:

```markdown
## Key Teradata Tables

### Legacy Schema (LIN_* tables)

- `LIN_DATABASE`, `LIN_TABLE`, `LIN_COLUMN` - Asset registries extracted from DBC views
- `LIN_COLUMN_LINEAGE` - Column-to-column relationships (core lineage data)
- `LIN_TABLE_LINEAGE` - Table-level lineage summary
- `LIN_TRANSFORMATION` - Transformation metadata
- `LIN_QUERY` - Query registry from DBQL
- `LIN_WATERMARK` - Incremental extraction tracking

### OpenLineage Schema (OL_* tables)

Aligned with [OpenLineage spec v2-0-2](https://openlineage.io/docs/spec/object-model):

- `OL_NAMESPACE` - Data source namespaces (teradata://host:port)
- `OL_DATASET` - Dataset registry (tables/views)
- `OL_DATASET_FIELD` - Field definitions (columns)
- `OL_JOB` - Job definitions (ETL processes)
- `OL_RUN` - Job execution runs
- `OL_RUN_INPUT`, `OL_RUN_OUTPUT` - Run input/output datasets
- `OL_COLUMN_LINEAGE` - Column-level lineage with OpenLineage transformation types
- `OL_SCHEMA_VERSION` - Schema version tracking
```

Also update the "API Endpoints" section to include v2:

```markdown
## API Endpoints

### v1 API (Legacy)

- `GET /api/v1/assets/databases` - List databases
- `GET /api/v1/assets/databases/{db}/tables` - List tables
- `GET /api/v1/assets/databases/{db}/tables/{table}/columns` - List columns
- `GET /api/v1/lineage/{assetId}` - Get lineage graph
- `GET /api/v1/search?q=query` - Search assets

### v2 API (OpenLineage-aligned)

- `GET /api/v2/openlineage/namespaces` - List namespaces
- `GET /api/v2/openlineage/namespaces/{namespaceId}` - Get namespace
- `GET /api/v2/openlineage/namespaces/{namespaceId}/datasets` - List datasets
- `GET /api/v2/openlineage/datasets/{datasetId}` - Get dataset with fields
- `GET /api/v2/openlineage/datasets/search?q=query` - Search datasets
- `GET /api/v2/openlineage/lineage/{datasetId}/{fieldName}` - Get lineage graph
```

Update the "Common Commands" section to include OpenLineage flags:

```bash
# Database with OpenLineage tables
cd database
python setup_lineage_schema.py --openlineage  # Create both LIN_* and OL_* tables
python populate_lineage.py --openlineage      # Populate OL_* tables
```
  </action>
  <verify>Read the updated CLAUDE.md and verify OpenLineage sections are present.</verify>
  <done>CLAUDE.md updated with OpenLineage schema and v2 API documentation.</done>
</task>

<task type="auto">
  <name>Task 2: Update user guide with OpenLineage documentation</name>
  <files>docs/user_guide.md</files>
  <action>
Add a new section to the user guide documenting OpenLineage integration. Find an appropriate location (after existing schema documentation or at the end) and add:

```markdown
## OpenLineage Integration

This application supports the [OpenLineage](https://openlineage.io/) standard (spec version 2-0-2) for data lineage metadata interoperability.

### OpenLineage Schema

The OpenLineage-aligned schema provides:

- **Namespace-based identification**: Assets are identified using URIs (e.g., `teradata://host:1025`)
- **Standardized transformation types**: DIRECT/INDIRECT with subtypes (IDENTITY, TRANSFORMATION, AGGREGATION, JOIN, FILTER, etc.)
- **Event-based model**: Supports tracking lineage discovery through job runs
- **Facet extensibility**: Schema designed for future facet additions

### Setting Up OpenLineage Tables

```bash
# Create OpenLineage tables alongside legacy tables
cd database
python setup_lineage_schema.py --openlineage

# Populate OpenLineage tables
python populate_lineage.py --openlineage
```

### v2 API Endpoints

The v2 API follows OpenLineage conventions:

| Endpoint | Description |
|----------|-------------|
| `GET /api/v2/openlineage/namespaces` | List all data source namespaces |
| `GET /api/v2/openlineage/namespaces/{id}` | Get namespace details |
| `GET /api/v2/openlineage/namespaces/{id}/datasets` | List datasets in namespace |
| `GET /api/v2/openlineage/datasets/{id}` | Get dataset with fields |
| `GET /api/v2/openlineage/datasets/search?q=query` | Search datasets |
| `GET /api/v2/openlineage/lineage/{datasetId}/{fieldName}` | Get field lineage graph |

### Lineage Query Parameters

The lineage endpoint supports:

| Parameter | Values | Default | Description |
|-----------|--------|---------|-------------|
| `direction` | `upstream`, `downstream`, `both` | `both` | Lineage direction to traverse |
| `maxDepth` | 1-20 | 5 | Maximum traversal depth |

### Transformation Types

OpenLineage defines two primary transformation types:

| Type | Subtypes | Description |
|------|----------|-------------|
| DIRECT | IDENTITY, TRANSFORMATION, AGGREGATION | Value directly derived from source |
| INDIRECT | JOIN, FILTER, GROUP_BY, SORT, WINDOW, CONDITIONAL | Value influenced by source but not directly derived |

### Migration from v1 to v2 API

The v1 API (`/api/v1/*`) remains fully functional for backward compatibility. Key differences:

| Aspect | v1 API | v2 API |
|--------|--------|--------|
| Asset identification | `database.table.column` format | Namespace + dataset + field |
| Transformation types | Single type (DIRECT, CALCULATION, etc.) | Type + subtype (DIRECT/IDENTITY, etc.) |
| Schema alignment | Custom LIN_* tables | OpenLineage OL_* tables |
| Namespace | Implicit | Explicit URI format |

### Example: Fetching Lineage

```bash
# v2 API example
curl "http://localhost:8080/api/v2/openlineage/lineage/demo_user.STG_CUSTOMER/customer_id?direction=upstream&maxDepth=3"
```

Response includes OpenLineage-structured graph with transformation type/subtype:

```json
{
  "datasetId": "demo_user.STG_CUSTOMER",
  "fieldName": "customer_id",
  "direction": "upstream",
  "maxDepth": 3,
  "graph": {
    "nodes": [...],
    "edges": [
      {
        "id": "...",
        "source": "demo_user.SRC_CUSTOMER/customer_id",
        "target": "demo_user.STG_CUSTOMER/customer_id",
        "transformationType": "DIRECT",
        "transformationSubtype": "IDENTITY"
      }
    ]
  }
}
```
```
  </action>
  <verify>Read the updated docs/user_guide.md and verify OpenLineage section is present with examples.</verify>
  <done>User guide updated with comprehensive OpenLineage documentation.</done>
</task>

<task type="auto">
  <name>Task 3: Create or update database README</name>
  <files>database/README.md</files>
  <action>
Create or update the database README with schema documentation:

```markdown
# Database Schema

This directory contains scripts for managing the Teradata lineage database schema.

## Schema Versions

### Legacy Schema (LIN_* tables)

The original lineage schema uses `LIN_` prefixed tables:

- **LIN_DATABASE** - Database registry
- **LIN_TABLE** - Table registry
- **LIN_COLUMN** - Column registry
- **LIN_COLUMN_LINEAGE** - Column-to-column lineage relationships
- **LIN_TABLE_LINEAGE** - Table-level lineage summary
- **LIN_TRANSFORMATION** - Transformation definitions
- **LIN_QUERY** - Query registry (from DBQL)
- **LIN_WATERMARK** - Extraction watermarks

### OpenLineage Schema (OL_* tables)

The OpenLineage-aligned schema follows [spec v2-0-2](https://openlineage.io/):

- **OL_NAMESPACE** - Data source namespaces (URI format)
- **OL_DATASET** - Dataset registry (maps to tables)
- **OL_DATASET_FIELD** - Field definitions (maps to columns)
- **OL_JOB** - Job definitions
- **OL_RUN** - Job execution runs
- **OL_RUN_INPUT** - Run input datasets
- **OL_RUN_OUTPUT** - Run output datasets
- **OL_COLUMN_LINEAGE** - Column lineage with OL transformation types
- **OL_SCHEMA_VERSION** - Schema version tracking

## Scripts

| Script | Purpose |
|--------|---------|
| `setup_lineage_schema.py` | Create database tables |
| `populate_lineage.py` | Extract metadata and populate lineage |
| `extract_dbql_lineage.py` | Extract lineage from DBQL |
| `setup_test_data.py` | Create test data tables |
| `run_tests.py` | Run database tests |

## Usage

### Setup Legacy Schema Only

```bash
python setup_lineage_schema.py
python populate_lineage.py
```

### Setup OpenLineage Schema

```bash
python setup_lineage_schema.py --openlineage
python populate_lineage.py --openlineage
```

### OpenLineage-Only Setup

```bash
python setup_lineage_schema.py --openlineage-only
python populate_lineage.py --openlineage
```

## Configuration

Uses environment variables from `.env` or `db_config.py`:

- `TERADATA_HOST` / `TD_HOST` - Database host
- `TERADATA_USER` / `TD_USER` - Username
- `TERADATA_PASSWORD` / `TD_PASSWORD` - Password
- `TERADATA_DATABASE` / `TD_DATABASE` - Default database

## OpenLineage Transformation Mapping

| Legacy Type | OpenLineage Type | OpenLineage Subtype |
|-------------|------------------|---------------------|
| DIRECT | DIRECT | IDENTITY |
| CALCULATION | DIRECT | TRANSFORMATION |
| AGGREGATION | DIRECT | AGGREGATION |
| JOIN | INDIRECT | JOIN |
| FILTER | INDIRECT | FILTER |
```
  </action>
  <verify>Read the database/README.md and verify schema documentation is present.</verify>
  <done>Database README created/updated with schema documentation.</done>
</task>

</tasks>

<verification>
1. Read CLAUDE.md and verify OpenLineage sections are present
2. Read docs/user_guide.md and verify OpenLineage documentation
3. Read database/README.md and verify schema documentation
4. Verify spec version (2-0-2) is mentioned in documentation
5. Verify transformation type mapping is documented
</verification>

<success_criteria>
- CLAUDE.md includes OpenLineage schema and v2 API information
- User guide has comprehensive OpenLineage section
- Database README documents both schema versions
- Migration path from v1 to v2 is documented
- OpenLineage spec reference is included
- Transformation type mapping is clearly documented
</success_criteria>

<output>
After completion, create `.planning/phases/08-open-lineage-standard-alignment/08-07-SUMMARY.md`
</output>
