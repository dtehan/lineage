---
phase: 08-open-lineage-standard-alignment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - database/setup_lineage_schema.py
autonomous: true

must_haves:
  truths:
    - "OL_NAMESPACE table exists with namespace_id, namespace_uri, created_at columns"
    - "OL_DATASET table exists with dataset_id, namespace_id, name, description, created_at columns"
    - "OL_DATASET_FIELD table exists with field_id, dataset_id, field_name, field_type, ordinal_position columns"
    - "OL_JOB table exists with job_id, namespace_id, name, description, created_at columns"
    - "OL_RUN table exists with run_id, job_id, event_type, event_time, nominal_time columns"
    - "OL_COLUMN_LINEAGE table exists with all OpenLineage-aligned columns"
    - "Tables include version tracking columns (schema_version, spec_version)"
    - "Indexes created for primary query patterns"
  artifacts:
    - path: "database/setup_lineage_schema.py"
      provides: "OpenLineage-aligned database schema DDL"
      contains: "OL_NAMESPACE"
  key_links:
    - from: "database/setup_lineage_schema.py"
      to: "Teradata database"
      via: "teradatasql connection"
      pattern: "CREATE.*TABLE.*demo_user\\.OL_"
---

<objective>
Create OpenLineage-aligned database schema (OL_* tables) to replace the existing LIN_* tables.

Purpose: Establish the database foundation for OpenLineage compliance. This schema follows the spec v2-0-2 event model with materialized lineage views, enabling interoperability with industry-standard lineage tools.

Output: Updated setup_lineage_schema.py that creates OL_* tables alongside existing LIN_* tables (for migration compatibility).
</objective>

<execution_context>
@/Users/Daniel.Tehan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Daniel.Tehan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-open-lineage-standard-alignment/08-RESEARCH.md
@database/setup_lineage_schema.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OL_* table DDL statements to setup_lineage_schema.py</name>
  <files>database/setup_lineage_schema.py</files>
  <action>
Add new DDL statements for OpenLineage-aligned tables. Create a new list `OL_DDL_STATEMENTS` containing:

1. **OL_NAMESPACE** - Namespace registry (connection URIs)
   ```sql
   CREATE MULTISET TABLE demo_user.OL_NAMESPACE (
       namespace_id VARCHAR(64) NOT NULL,
       namespace_uri VARCHAR(512) NOT NULL,  -- e.g., "teradata://host:1025"
       description VARCHAR(2000),
       spec_version VARCHAR(20) DEFAULT '2-0-2',
       created_at TIMESTAMP(0),
       PRIMARY KEY (namespace_id)
   )
   ```

2. **OL_DATASET** - Dataset registry (tables)
   ```sql
   CREATE MULTISET TABLE demo_user.OL_DATASET (
       dataset_id VARCHAR(256) NOT NULL,     -- namespace_id + '/' + name
       namespace_id VARCHAR(64) NOT NULL,
       name VARCHAR(256) NOT NULL,           -- database.table format
       description VARCHAR(2000),
       source_type VARCHAR(50),              -- TABLE, VIEW
       created_at TIMESTAMP(0),
       updated_at TIMESTAMP(0),
       is_active CHAR(1) DEFAULT 'Y',
       PRIMARY KEY (dataset_id)
   )
   ```

3. **OL_DATASET_FIELD** - Dataset fields (columns)
   ```sql
   CREATE MULTISET TABLE demo_user.OL_DATASET_FIELD (
       field_id VARCHAR(512) NOT NULL,       -- dataset_id + '/' + field_name
       dataset_id VARCHAR(256) NOT NULL,
       field_name VARCHAR(256) NOT NULL,
       field_type VARCHAR(256),
       field_description VARCHAR(2000),
       ordinal_position INTEGER,             -- 1-indexed per spec
       nullable CHAR(1),
       created_at TIMESTAMP(0),
       PRIMARY KEY (field_id)
   )
   ```

4. **OL_JOB** - Job definitions (ETL processes)
   ```sql
   CREATE MULTISET TABLE demo_user.OL_JOB (
       job_id VARCHAR(256) NOT NULL,
       namespace_id VARCHAR(64) NOT NULL,
       name VARCHAR(256) NOT NULL,
       description VARCHAR(2000),
       job_type VARCHAR(50),                 -- SQL, ETL, etc.
       created_at TIMESTAMP(0),
       updated_at TIMESTAMP(0),
       PRIMARY KEY (job_id)
   )
   ```

5. **OL_RUN** - Run instances (job executions)
   ```sql
   CREATE MULTISET TABLE demo_user.OL_RUN (
       run_id VARCHAR(64) NOT NULL,
       job_id VARCHAR(256) NOT NULL,
       event_type VARCHAR(20),               -- START, RUNNING, COMPLETE, ABORT, FAIL
       event_time TIMESTAMP(6),
       nominal_start_time TIMESTAMP(0),
       nominal_end_time TIMESTAMP(0),
       producer VARCHAR(512),
       schema_url VARCHAR(512),
       created_at TIMESTAMP(0),
       PRIMARY KEY (run_id)
   )
   ```

6. **OL_RUN_INPUT** - Run input datasets
   ```sql
   CREATE MULTISET TABLE demo_user.OL_RUN_INPUT (
       run_id VARCHAR(64) NOT NULL,
       dataset_id VARCHAR(256) NOT NULL,
       PRIMARY KEY (run_id, dataset_id)
   )
   ```

7. **OL_RUN_OUTPUT** - Run output datasets
   ```sql
   CREATE MULTISET TABLE demo_user.OL_RUN_OUTPUT (
       run_id VARCHAR(64) NOT NULL,
       dataset_id VARCHAR(256) NOT NULL,
       PRIMARY KEY (run_id, dataset_id)
   )
   ```

8. **OL_COLUMN_LINEAGE** - Materialized column lineage (core query table)
   ```sql
   CREATE MULTISET TABLE demo_user.OL_COLUMN_LINEAGE (
       lineage_id VARCHAR(64) NOT NULL,
       run_id VARCHAR(64),                   -- Which run discovered this (NULL for manual)
       source_namespace VARCHAR(512) NOT NULL,
       source_dataset VARCHAR(256) NOT NULL,
       source_field VARCHAR(256) NOT NULL,
       target_namespace VARCHAR(512) NOT NULL,
       target_dataset VARCHAR(256) NOT NULL,
       target_field VARCHAR(256) NOT NULL,
       transformation_type VARCHAR(20),      -- DIRECT, INDIRECT
       transformation_subtype VARCHAR(50),   -- IDENTITY, TRANSFORMATION, AGGREGATION, JOIN, FILTER, etc.
       transformation_description VARCHAR(2000),
       masking CHAR(1) DEFAULT 'N',
       confidence_score DECIMAL(3,2),
       discovered_at TIMESTAMP(0),
       is_active CHAR(1) DEFAULT 'Y',
       PRIMARY KEY (lineage_id)
   )
   ```

Also add a version tracking table:
9. **OL_SCHEMA_VERSION** - Track schema version
   ```sql
   CREATE MULTISET TABLE demo_user.OL_SCHEMA_VERSION (
       version_id INTEGER NOT NULL,
       openlineage_spec_version VARCHAR(20) NOT NULL,
       schema_version VARCHAR(20) NOT NULL,
       applied_at TIMESTAMP(0),
       description VARCHAR(500),
       PRIMARY KEY (version_id)
   )
   ```

Keep the existing LIN_* DDL_STATEMENTS list unchanged for backward compatibility.
  </action>
  <verify>Read the file and verify OL_DDL_STATEMENTS list contains all 9 table definitions with correct column types and constraints.</verify>
  <done>OL_DDL_STATEMENTS list exists with complete DDL for all OpenLineage-aligned tables.</done>
</task>

<task type="auto">
  <name>Task 2: Add OL_* index statements</name>
  <files>database/setup_lineage_schema.py</files>
  <action>
Add new index statements list `OL_INDEX_STATEMENTS` containing indexes for efficient querying:

```python
OL_INDEX_STATEMENTS = [
    # Namespace lookups
    "CREATE INDEX idx_ol_namespace_uri (namespace_uri) ON demo_user.OL_NAMESPACE",

    # Dataset lookups
    "CREATE INDEX idx_ol_dataset_ns (namespace_id) ON demo_user.OL_DATASET",
    "CREATE INDEX idx_ol_dataset_name (name) ON demo_user.OL_DATASET",

    # Field lookups
    "CREATE INDEX idx_ol_field_dataset (dataset_id) ON demo_user.OL_DATASET_FIELD",
    "CREATE INDEX idx_ol_field_name (field_name) ON demo_user.OL_DATASET_FIELD",

    # Job lookups
    "CREATE INDEX idx_ol_job_ns (namespace_id) ON demo_user.OL_JOB",
    "CREATE INDEX idx_ol_job_name (name) ON demo_user.OL_JOB",

    # Run lookups
    "CREATE INDEX idx_ol_run_job (job_id) ON demo_user.OL_RUN",
    "CREATE INDEX idx_ol_run_time (event_time) ON demo_user.OL_RUN",
    "CREATE INDEX idx_ol_run_type (event_type) ON demo_user.OL_RUN",

    # Run input/output lookups
    "CREATE INDEX idx_ol_run_input_ds (dataset_id) ON demo_user.OL_RUN_INPUT",
    "CREATE INDEX idx_ol_run_output_ds (dataset_id) ON demo_user.OL_RUN_OUTPUT",

    # Column lineage lookups (critical for graph traversal)
    "CREATE INDEX idx_ol_lineage_src_ds (source_dataset) ON demo_user.OL_COLUMN_LINEAGE",
    "CREATE INDEX idx_ol_lineage_src_field (source_field) ON demo_user.OL_COLUMN_LINEAGE",
    "CREATE INDEX idx_ol_lineage_tgt_ds (target_dataset) ON demo_user.OL_COLUMN_LINEAGE",
    "CREATE INDEX idx_ol_lineage_tgt_field (target_field) ON demo_user.OL_COLUMN_LINEAGE",
    "CREATE INDEX idx_ol_lineage_run (run_id) ON demo_user.OL_COLUMN_LINEAGE",
    "CREATE INDEX idx_ol_lineage_type (transformation_type) ON demo_user.OL_COLUMN_LINEAGE",
]
```
  </action>
  <verify>Read the file and verify OL_INDEX_STATEMENTS list contains all index definitions.</verify>
  <done>OL_INDEX_STATEMENTS list exists with indexes for namespace, dataset, field, job, run, and lineage tables.</done>
</task>

<task type="auto">
  <name>Task 3: Update main() to create OL_* tables</name>
  <files>database/setup_lineage_schema.py</files>
  <action>
Modify the main() function to:

1. Add a new `--openlineage` / `-o` flag to argparse to opt into creating OL_* tables:
   ```python
   parser = argparse.ArgumentParser(description="Setup lineage schema for Teradata")
   parser.add_argument("--openlineage", "-o", action="store_true",
                       help="Create OpenLineage-aligned OL_* tables (in addition to LIN_* tables)")
   parser.add_argument("--openlineage-only", action="store_true",
                       help="Only create OpenLineage tables (skip LIN_* tables)")
   args = parser.parse_args()
   ```

2. Add OL_* tables to drop list when `--openlineage` or `--openlineage-only` is used:
   ```python
   ol_tables_to_drop = [
       "OL_SCHEMA_VERSION",
       "OL_COLUMN_LINEAGE",
       "OL_RUN_OUTPUT",
       "OL_RUN_INPUT",
       "OL_RUN",
       "OL_JOB",
       "OL_DATASET_FIELD",
       "OL_DATASET",
       "OL_NAMESPACE"
   ]
   ```

3. Create OL_* tables when flag is present:
   ```python
   if args.openlineage or args.openlineage_only:
       print("\n--- Creating OpenLineage tables ---")
       for i, ddl in enumerate(OL_DDL_STATEMENTS, 1):
           table_name = ddl.split("demo_user.")[1].split()[0]
           print(f"  Creating {table_name}...", end=" ")
           try:
               cursor.execute(ddl)
               print("OK")
           except Exception as e:
               print(f"FAILED: {e}")
               sys.exit(1)
   ```

4. Create OL_* indexes when flag is present.

5. Insert initial schema version record:
   ```python
   cursor.execute("""
       INSERT INTO demo_user.OL_SCHEMA_VERSION
       (version_id, openlineage_spec_version, schema_version, applied_at, description)
       VALUES (1, '2-0-2', '1.0.0', CURRENT_TIMESTAMP, 'Initial OpenLineage schema')
   """)
   ```

6. Update verification to include OL_* tables when appropriate.
  </action>
  <verify>Run `python database/setup_lineage_schema.py --help` and verify --openlineage flag is documented. Then run with `--openlineage` flag (if safe) or verify code structure.</verify>
  <done>setup_lineage_schema.py accepts --openlineage flag and creates all OL_* tables with indexes and version tracking.</done>
</task>

</tasks>

<verification>
1. Code review: Verify OL_DDL_STATEMENTS contains all 9 table definitions
2. Code review: Verify OL_INDEX_STATEMENTS contains all index definitions
3. Code review: Verify main() handles --openlineage and --openlineage-only flags
4. Syntax check: `python -m py_compile database/setup_lineage_schema.py`
5. Help check: `python database/setup_lineage_schema.py --help` shows new flags
</verification>

<success_criteria>
- setup_lineage_schema.py compiles without syntax errors
- Running with --openlineage flag creates OL_* tables in Teradata
- OL_COLUMN_LINEAGE table has OpenLineage-aligned columns (transformation_type, transformation_subtype)
- Schema version tracking is in place (OL_SCHEMA_VERSION with spec version 2-0-2)
</success_criteria>

<output>
After completion, create `.planning/phases/08-open-lineage-standard-alignment/08-01-SUMMARY.md`
</output>
