---
phase: 22-selection-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lineage-ui/src/components/domain/LineageGraph/hooks/useFitToSelection.ts
  - lineage-ui/src/components/domain/LineageGraph/hooks/index.ts
  - lineage-ui/src/components/domain/LineageGraph/Toolbar.tsx
  - lineage-ui/src/components/domain/LineageGraph/LineageGraph.tsx
autonomous: true

must_haves:
  truths:
    - "User can click 'Fit to selection' to center viewport on highlighted lineage path"
    - "Fit-to-selection includes appropriate padding around selected nodes"
    - "Fit-to-selection button is disabled when no column is selected"
    - "Selection state persists when user changes graph depth (column still in graph)"
    - "Selection clears gracefully when selected column no longer exists after depth change"
  artifacts:
    - path: "lineage-ui/src/components/domain/LineageGraph/hooks/useFitToSelection.ts"
      provides: "Hook encapsulating fitView logic for highlighted nodes"
      exports: ["useFitToSelection"]
    - path: "lineage-ui/src/components/domain/LineageGraph/Toolbar.tsx"
      provides: "Fit to selection button in toolbar action area"
      contains: "Crosshair"
    - path: "lineage-ui/src/components/domain/LineageGraph/LineageGraph.tsx"
      provides: "Wiring of fit-to-selection hook and selection persistence fix"
      contains: "useFitToSelection"
  key_links:
    - from: "useFitToSelection.ts"
      to: "@xyflow/react useReactFlow"
      via: "reactFlowInstance.fitView with nodes filter"
      pattern: "fitView.*nodes.*padding.*duration"
    - from: "useFitToSelection.ts"
      to: "useLineageStore"
      via: "reads highlightedNodeIds to determine which table nodes to fit"
      pattern: "highlightedNodeIds"
    - from: "LineageGraph.tsx"
      to: "useFitToSelection.ts"
      via: "hook call, passes fitToSelection and hasSelection to Toolbar"
      pattern: "useFitToSelection"
    - from: "LineageGraph.tsx"
      to: "storeNodes"
      via: "checks if selectedAssetId still exists after graph data changes"
      pattern: "storeNodes.*selectedAssetId"
---

<objective>
Add "Fit to selection" viewport control and fix selection persistence across depth changes.

Purpose: Users need to center the viewport on their highlighted lineage path (especially in large graphs where the path extends beyond the viewport). Selection must also survive depth changes so users can explore different depths without losing context.
Output: `useFitToSelection` hook, updated Toolbar with Crosshair button, fixed highlight recomputation effect in LineageGraph.
</objective>

<execution_context>
@/Users/Daniel.Tehan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Daniel.Tehan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-selection-features/22-RESEARCH.md

@lineage-ui/src/components/domain/LineageGraph/hooks/useLineageHighlight.ts
@lineage-ui/src/components/domain/LineageGraph/hooks/useSmartViewport.ts
@lineage-ui/src/components/domain/LineageGraph/hooks/index.ts
@lineage-ui/src/components/domain/LineageGraph/Toolbar.tsx
@lineage-ui/src/components/domain/LineageGraph/LineageGraph.tsx
@lineage-ui/src/stores/useLineageStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useFitToSelection hook and add Toolbar button</name>
  <files>
    lineage-ui/src/components/domain/LineageGraph/hooks/useFitToSelection.ts
    lineage-ui/src/components/domain/LineageGraph/hooks/index.ts
    lineage-ui/src/components/domain/LineageGraph/Toolbar.tsx
  </files>
  <action>
Create `useFitToSelection.ts` in the hooks directory:

1. Import `useCallback` from react, `useReactFlow` from `@xyflow/react`, and `useLineageStore` from the store (path: `../../../../stores/useLineageStore`).
2. Define constants: `FIT_TO_SELECTION_PADDING = 0.15` and `FIT_TO_SELECTION_DURATION = 300` (matches panel slide animation timing from Phase 19).
3. Export function `useFitToSelection()` that:
   - Gets `reactFlowInstance` from `useReactFlow()`
   - Gets `highlightedNodeIds` from `useLineageStore(state => state.highlightedNodeIds)` (selector pattern for performance)
   - Creates `fitToSelection` callback that:
     - Returns early if `highlightedNodeIds.size === 0`
     - Gets all nodes via `reactFlowInstance.getNodes()`
     - Maps column IDs (from `highlightedNodeIds`) to parent table node IDs by iterating nodes: for each node with `node.type === 'tableNode'`, check if `(node.data as any)?.columns` array has any column with `id` in the highlighted set
     - Returns early if no table node IDs found
     - Calls `reactFlowInstance.fitView({ nodes: tableNodeIds.map(id => ({ id })), padding: FIT_TO_SELECTION_PADDING, duration: FIT_TO_SELECTION_DURATION })`
   - Returns `{ fitToSelection, hasSelection: highlightedNodeIds.size > 0 }`

Update `hooks/index.ts`:
- Add `export * from './useFitToSelection';`

Update `Toolbar.tsx`:
- Add `Crosshair` to the lucide-react import (alongside existing `Focus`)
- Add two optional props to `ToolbarProps`: `onFitToSelection?: () => void;` and `hasSelection?: boolean;`
- Destructure the new props in the component (default `hasSelection` to `false`)
- After the existing "Fit to view" button (the `<Tooltip content="Center and zoom to fit all nodes"...>` block around line 244-253), add a new button:
  ```
  {onFitToSelection && (
    <Tooltip content="Center viewport on selected lineage path" position="bottom">
      <button
        onClick={onFitToSelection}
        disabled={isLoading || !hasSelection}
        className="p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50"
        aria-label="Fit to selection"
      >
        <Crosshair className="w-4 h-4" />
      </button>
    </Tooltip>
  )}
  ```
  This button uses the same styling pattern as the existing Fit to View button and is disabled when loading or when there is no active selection.
  </action>
  <verify>
Run `cd /Users/Daniel.Tehan/Code/lineage/lineage-ui && npx tsc --noEmit` to verify no TypeScript errors. Verify the hook file exists and exports `useFitToSelection`. Verify Toolbar.tsx compiles with the new props.
  </verify>
  <done>
`useFitToSelection` hook exists with `fitToSelection` and `hasSelection` return values. Toolbar has a Crosshair "Fit to selection" button that is disabled when `!hasSelection` or `isLoading`. Hook is exported from hooks/index.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire fit-to-selection into LineageGraph and fix selection persistence</name>
  <files>
    lineage-ui/src/components/domain/LineageGraph/LineageGraph.tsx
  </files>
  <action>
Modify `LineageGraphInner` in `LineageGraph.tsx`:

**1. Import and call useFitToSelection:**
- Add `useFitToSelection` to the import from `'./hooks'` (line 34-38)
- After the `useSmartViewport` call (~line 135), add:
  ```typescript
  const { fitToSelection, hasSelection } = useFitToSelection();
  ```

**2. Prevent smart viewport from overriding fit-to-selection:**
- Create a `handleFitToSelection` callback that marks user interaction before fitting:
  ```typescript
  const handleFitToSelection = useCallback(() => {
    hasUserInteractedRef.current = true;
    fitToSelection();
  }, [fitToSelection]);
  ```
  This sets `hasUserInteractedRef.current = true` so the `useSmartViewport` effect (line 215-227) won't override the viewport after a depth change triggers new data. This matches the existing pattern used by `onNodeDragStart`.

**3. Pass fit-to-selection to Toolbar:**
- In the `<Toolbar>` JSX (~line 470-485), add two new props:
  ```
  onFitToSelection={handleFitToSelection}
  hasSelection={hasSelection}
  ```

**4. Fix selection persistence (SELECT-05):**
- Find the highlight effect (~line 249-255):
  ```typescript
  useEffect(() => {
    if (selectedAssetId) {
      const { highlightedNodes, highlightedEdges } = highlightPath(selectedAssetId);
      setHighlightedPath(highlightedNodes, highlightedEdges);
      openPanel('node');
    }
  }, [selectedAssetId, highlightPath, setHighlightedPath, openPanel]);
  ```
- Replace it with a version that handles depth changes gracefully:
  ```typescript
  useEffect(() => {
    if (selectedAssetId) {
      // Verify selected column still exists in current graph after depth change
      const stillExists = storeNodes.some(n => n.id === selectedAssetId);
      if (stillExists) {
        const { highlightedNodes, highlightedEdges } = highlightPath(selectedAssetId);
        setHighlightedPath(highlightedNodes, highlightedEdges);
        if (!isPanelOpen) {
          openPanel('node');
        }
      } else {
        // Column no longer in graph (e.g., depth was reduced)
        clearHighlight();
        closePanel();
      }
    }
  }, [selectedAssetId, highlightPath, setHighlightedPath, openPanel, isPanelOpen,
      storeNodes, clearHighlight, closePanel]);
  ```
  Key changes from existing code:
  - Added `storeNodes` dependency so the effect re-runs when graph data changes (not just when `selectedAssetId` changes)
  - Added existence check: `storeNodes.some(n => n.id === selectedAssetId)` -- if the column was at depth 4 but user reduced to depth 1, it won't be in the graph
  - Changed from always calling `openPanel('node')` to only opening if panel isn't already open (`if (!isPanelOpen)`) -- prevents re-triggering the panel slide animation when highlight just recomputes
  - If column no longer exists, calls `clearHighlight()` and `closePanel()` for clean state
  - Added `clearHighlight` and `closePanel` to the dependency array

NOTE: The `highlightPath` callback from `useLineageHighlight` already depends on `edges` (via its `useMemo` adjacency maps). When depth changes -> new API data -> new edges -> new `highlightPath` reference -> this effect re-runs. Adding `storeNodes` handles the case where the column itself disappears from the graph.
  </action>
  <verify>
Run `cd /Users/Daniel.Tehan/Code/lineage/lineage-ui && npx tsc --noEmit` to verify no TypeScript errors. Run `cd /Users/Daniel.Tehan/Code/lineage/lineage-ui && npm test -- --run` to verify all existing tests pass. Check that the Toolbar now receives `onFitToSelection` and `hasSelection` props.
  </verify>
  <done>
LineageGraph wires `useFitToSelection` hook, passes `onFitToSelection` and `hasSelection` to Toolbar. Selection persistence effect checks if selected column still exists in graph after depth change, recomputes highlight if yes, clears selection if no. `handleFitToSelection` sets `hasUserInteractedRef` to prevent smart viewport override.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm test -- --run` passes all existing tests (no regressions)
3. `useFitToSelection.ts` exports the hook correctly
4. Toolbar displays Crosshair button next to existing Focus button
5. Button is disabled when no selection active (`hasSelection === false`)
6. Selection persistence effect includes `storeNodes` in dependencies
</verification>

<success_criteria>
- Fit-to-selection hook exists and uses `reactFlowInstance.fitView` with `nodes` filter, `padding: 0.15`, `duration: 300`
- Toolbar shows disabled Crosshair button when no selection, enabled when selection active
- Clicking Crosshair calls `fitToSelection` which centers viewport on highlighted table nodes
- `hasUserInteractedRef` is set before fit-to-selection to prevent smart viewport override
- Highlight recomputes after depth change if selected column still exists in graph
- Selection clears cleanly if selected column no longer in graph after depth reduction
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/22-selection-features/22-01-SUMMARY.md`
</output>
