---
phase: 10-asset-browser-integration
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - lineage-ui/src/components/domain/AssetBrowser/AssetBrowser.tsx
  - lineage-ui/src/components/domain/AssetBrowser/AssetBrowser.test.tsx
autonomous: true

must_haves:
  truths:
    - "User sees pagination controls below column list when table is expanded"
    - "Pagination resets to page 1 when switching to a different table"
    - "User can navigate through column pages when table has many columns"
  artifacts:
    - path: "lineage-ui/src/components/domain/AssetBrowser/AssetBrowser.tsx"
      provides: "AssetBrowser with pagination at all three levels"
      contains: "Pagination"
    - path: "lineage-ui/src/components/domain/AssetBrowser/AssetBrowser.test.tsx"
      provides: "Updated tests for OpenLineage hooks"
      contains: "useOpenLineageDatasets"
  key_links:
    - from: "AssetBrowser.test.tsx"
      to: "useOpenLineage hooks"
      via: "vi.mock"
      pattern: "vi\\.mock.*useOpenLineage"
    - from: "DatasetItem"
      to: "fields.slice"
      via: "client-side pagination"
      pattern: "fields\\.slice\\(fieldOffset"
---

<objective>
Add column-level pagination and update tests to use OpenLineage hook mocks.

Purpose: Complete pagination integration at all three levels (databases, tables, columns) and align test mocks with the actual component implementation (which uses OpenLineage hooks, not v1 hooks).

Output: Fully paginated AssetBrowser with updated test infrastructure.
</objective>

<execution_context>
@/Users/Daniel.Tehan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Daniel.Tehan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-asset-browser-integration/10-CONTEXT.md
@.planning/phases/10-asset-browser-integration/10-RESEARCH.md
@.planning/phases/10-asset-browser-integration/10-01-SUMMARY.md

@lineage-ui/src/components/common/Pagination.tsx
@lineage-ui/src/components/domain/AssetBrowser/AssetBrowser.tsx
@lineage-ui/src/components/domain/AssetBrowser/AssetBrowser.test.tsx
@lineage-ui/src/api/hooks/useOpenLineage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add column pagination to DatasetItem component</name>
  <files>lineage-ui/src/components/domain/AssetBrowser/AssetBrowser.tsx</files>
  <action>
Add pagination to the column/field list within expanded datasets.

**PAGINATION ARCHITECTURE (same as Plan 10-01):**
- Column pagination is CLIENT-SIDE slicing of the `fields` array
- Fields are fetched via useOpenLineageDataset when expanded (returns all fields)
- No server-side pagination needed - client slices the fields array

**1. Add pagination state to DatasetItem:**
```typescript
function DatasetItem({ dataset, isExpanded, onToggle }: DatasetItemProps) {
  const [fieldOffset, setFieldOffset] = useState(0);
  const FIELD_LIMIT = 100;

  // Fetch dataset with fields when expanded
  const { data: datasetWithFields } = useOpenLineageDataset(isExpanded ? dataset.id : '', {
    enabled: isExpanded,
  });
  const allFields = datasetWithFields?.fields || [];

  // Paginate fields (client-side)
  const totalFields = allFields.length;
  const paginatedFields = allFields.slice(fieldOffset, fieldOffset + FIELD_LIMIT);
  // ... rest of component
```

**2. Reset field pagination when dataset changes:**
```typescript
// Reset pagination when dataset changes
useEffect(() => {
  setFieldOffset(0);
}, [dataset.id]);
```

**3. Update field rendering to use paginated list:**
Replace:
```typescript
fields
  .sort((a, b) => a.ordinalPosition - b.ordinalPosition)
  .map((field) => ...)
```
With:
```typescript
paginatedFields
  .sort((a, b) => a.ordinalPosition - b.ordinalPosition)
  .map((field) => ...)
```

**4. Add pagination controls after field list:**
After the field list `</ul>` inside the expanded section (but within the `{isExpanded && ...}` block), wrap in fragment and add:
```typescript
{isExpanded && (
  <>
    <ul className="ml-4 mt-1 space-y-1">
      {paginatedFields.length === 0 ? (
        <li className="px-2 py-1 text-xs text-slate-400 italic">No fields found</li>
      ) : (
        paginatedFields
          .sort((a, b) => a.ordinalPosition - b.ordinalPosition)
          .map((field) => (...))
      )}
    </ul>
    {/* Field pagination - always visible per CONTEXT.md */}
    <div className="ml-4 mt-2 flex justify-center">
      <Pagination
        totalCount={totalFields}
        limit={FIELD_LIMIT}
        offset={fieldOffset}
        onPageChange={setFieldOffset}
        showFirstLast={true}
        showPageInfo={true}
      />
    </div>
  </>
)}
```

**Key notes:**
- Fields are fetched via useOpenLineageDataset when expanded
- The API returns all fields (no server-side pagination), so client-side slicing is appropriate
- Per CONTEXT.md: Pagination always visible, bottom placement, centered
  </action>
  <verify>
1. `cd /Users/Daniel.Tehan/Code/lineage/lineage-ui && npx tsc --noEmit` - No TypeScript errors
2. `cd /Users/Daniel.Tehan/Code/lineage/lineage-ui && npm run dev` - Start dev server
3. Visual: Pagination appears below field list when dataset is expanded
  </verify>
  <done>
- Pagination renders below field/column list when dataset expanded
- Pagination resets to page 1 when switching to different dataset
- Field navigation works via Next/Previous buttons
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update AssetBrowser test mocks to use OpenLineage hooks</name>
  <files>lineage-ui/src/components/domain/AssetBrowser/AssetBrowser.test.tsx</files>
  <action>
Update the test file to mock OpenLineage hooks instead of v1 hooks. This task focuses ONLY on updating the mock infrastructure - pagination tests are added in Plan 10-03.

**1. Update imports:**
Replace:
```typescript
import * as useAssetsModule from '../../../api/hooks/useAssets';
vi.mock('../../../api/hooks/useAssets');
```
With:
```typescript
import * as useOpenLineageModule from '../../../api/hooks/useOpenLineage';
vi.mock('../../../api/hooks/useOpenLineage');
```

**2. Create mock data matching OpenLineage types:**
```typescript
const mockNamespaces = {
  namespaces: [
    { id: 'ns-1', uri: 'teradata://localhost', specVersion: '1.0', createdAt: '2024-01-01' }
  ]
};

const mockDatasets = [
  { id: 'ds-1', namespace: 'ns-1', name: 'sales_db.orders', sourceType: 'table', createdAt: '2024-01-01', updatedAt: '2024-01-01' },
  { id: 'ds-2', namespace: 'ns-1', name: 'sales_db.customers', sourceType: 'table', createdAt: '2024-01-01', updatedAt: '2024-01-01' },
  { id: 'ds-3', namespace: 'ns-1', name: 'analytics_db.reports', sourceType: 'view', createdAt: '2024-01-01', updatedAt: '2024-01-01' },
];

const mockDatasetsWithViews = [
  { id: 'ds-1', namespace: 'ns-1', name: 'sales_db.orders', sourceType: 'table', createdAt: '2024-01-01', updatedAt: '2024-01-01' },
  { id: 'ds-2', namespace: 'ns-1', name: 'sales_db.customer_view', sourceType: 'view', createdAt: '2024-01-01', updatedAt: '2024-01-01' },
  { id: 'ds-3', namespace: 'ns-1', name: 'sales_db.sales_summary', sourceType: 'materialized_view', createdAt: '2024-01-01', updatedAt: '2024-01-01' },
];

const mockDatasetWithFields = {
  id: 'ds-1',
  namespace: 'ns-1',
  name: 'sales_db.orders',
  sourceType: 'table',
  createdAt: '2024-01-01',
  updatedAt: '2024-01-01',
  fields: [
    { id: 'f-1', name: 'order_id', type: 'INTEGER', ordinalPosition: 1, nullable: false },
    { id: 'f-2', name: 'customer_id', type: 'INTEGER', ordinalPosition: 2, nullable: false },
  ]
};
```

**3. Update beforeEach to mock OpenLineage hooks:**
```typescript
beforeEach(() => {
  vi.clearAllMocks();

  // Mock useOpenLineageNamespaces
  vi.mocked(useOpenLineageModule.useOpenLineageNamespaces).mockReturnValue({
    data: mockNamespaces,
    isLoading: false,
    isError: false,
    error: null,
    isSuccess: true,
  } as ReturnType<typeof useOpenLineageModule.useOpenLineageNamespaces>);

  // Mock useOpenLineageDatasets
  vi.mocked(useOpenLineageModule.useOpenLineageDatasets).mockReturnValue({
    data: { datasets: mockDatasets, total: mockDatasets.length },
    isLoading: false,
    isFetching: false,
    isError: false,
    error: null,
    isSuccess: true,
  } as ReturnType<typeof useOpenLineageModule.useOpenLineageDatasets>);

  // Mock useOpenLineageDataset (for field fetching)
  vi.mocked(useOpenLineageModule.useOpenLineageDataset).mockReturnValue({
    data: undefined,
    isLoading: false,
    isError: false,
    error: null,
    isSuccess: false,
  } as ReturnType<typeof useOpenLineageModule.useOpenLineageDataset>);
});
```

**4. Update TC-COMP-001 (Initial Render):**
```typescript
describe('TC-COMP-001: Initial Render', () => {
  it('displays loading spinner when loading', () => {
    vi.mocked(useOpenLineageModule.useOpenLineageNamespaces).mockReturnValue({
      data: undefined,
      isLoading: true,
      isError: false,
      error: null,
      isSuccess: false,
    } as ReturnType<typeof useOpenLineageModule.useOpenLineageNamespaces>);

    render(<AssetBrowser />);
    expect(screen.getByRole('status', { name: /loading/i })).toBeInTheDocument();
  });

  it('displays database list after loading', async () => {
    // Uses default mocks from beforeEach
    render(<AssetBrowser />);

    expect(screen.getByText('Databases')).toBeInTheDocument();
    // Databases are derived from dataset names (sales_db.orders -> sales_db)
    expect(screen.getByText('sales_db')).toBeInTheDocument();
    expect(screen.getByText('analytics_db')).toBeInTheDocument();
  });
});
```

**5. Update TC-COMP-002 (Database Expansion):**
- Clicking chevron expands/collapses database
- Tables (datasets) for that database are shown when expanded
- Update assertions to find by dataset name parsing (sales_db.orders -> orders)

**6. Update TC-COMP-003 (Table Expansion):**
- Mock useOpenLineageDataset to return mockDatasetWithFields when called
- Update field fetching assertions

**7. Update TC-COMP-004 (Column Selection):**
- The component now uses navigation (navigate()) instead of setSelectedAssetId
- Update test to mock useNavigate and verify navigation call
- Or check that the button click triggers the expected behavior

**8. Update TC-COMP-032a (View Visual Distinction):**
- Use mockDatasetsWithViews with sourceType values
- Verify table-icon, view-icon, materialized-view-icon data-testids

**9. Remove or update old pagination tests:**
The current TC-COMP-PAGE tests mock useDatabases which no longer exists. These tests will be replaced in Plan 10-03.
For now, either remove them or comment them out with a TODO noting they'll be rewritten.

**Key notes:**
- Keep all existing test case IDs (TC-COMP-001, TC-COMP-002, etc.)
- The component no longer uses useLineageStore.setSelectedAssetId - it navigates instead
- Remove the useLineageStore mock if it's not used by the component
  </action>
  <verify>
1. `cd /Users/Daniel.Tehan/Code/lineage/lineage-ui && npm test -- --run AssetBrowser` - Tests pass (excluding pagination tests which move to Plan 10-03)
2. `cd /Users/Daniel.Tehan/Code/lineage/lineage-ui && npx tsc --noEmit` - No TypeScript errors in test file
  </verify>
  <done>
- Test file imports and mocks OpenLineage hooks (not v1 hooks)
- TC-COMP-001 through TC-COMP-004 updated and passing
- TC-COMP-032a updated and passing
- Old pagination tests removed/commented (will be rewritten in Plan 10-03)
- No TypeScript errors
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd lineage-ui && npx tsc --noEmit`
2. Core tests pass: `cd lineage-ui && npm test -- --run AssetBrowser`
3. Visual verification: Pagination visible at all three levels (databases, tables, columns)
4. Column pagination reset verified when switching tables
</verification>

<success_criteria>
1. Column/field pagination works when dataset is expanded
2. Pagination resets to page 1 when switching tables
3. Test mocks updated to use OpenLineage hooks
4. Core test cases (TC-COMP-001 through TC-COMP-032a) pass
5. TypeScript compiles without errors
6. Pagination visible at all three levels: database list, table list, column list
</success_criteria>

<output>
After completion, create `.planning/phases/10-asset-browser-integration/10-02-SUMMARY.md`
</output>
