---
phase: 10-asset-browser-integration
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - lineage-ui/src/components/domain/AssetBrowser/AssetBrowser.tsx
  - lineage-ui/src/components/domain/AssetBrowser/AssetBrowser.test.tsx
autonomous: true

must_haves:
  truths:
    - "User sees pagination controls below column list when table is expanded"
    - "Pagination resets to page 1 when switching to a different table"
    - "All AssetBrowser unit tests pass"
  artifacts:
    - path: "lineage-ui/src/components/domain/AssetBrowser/AssetBrowser.tsx"
      provides: "AssetBrowser with pagination at all three levels"
      contains: "Pagination"
    - path: "lineage-ui/src/components/domain/AssetBrowser/AssetBrowser.test.tsx"
      provides: "Updated tests for OpenLineage hooks and pagination"
      contains: "useOpenLineageDatasets"
  key_links:
    - from: "AssetBrowser.test.tsx"
      to: "useOpenLineage hooks"
      via: "vi.mock"
      pattern: "vi\\.mock.*useOpenLineage"
---

<objective>
Add column-level pagination and update tests to match OpenLineage hook implementation.

Purpose: Complete pagination integration at all three levels (databases, tables, columns) and ensure all tests pass by aligning test mocks with the actual component implementation.

Output: Fully paginated AssetBrowser with passing test suite.
</objective>

<execution_context>
@/Users/Daniel.Tehan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Daniel.Tehan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-asset-browser-integration/10-CONTEXT.md
@.planning/phases/10-asset-browser-integration/10-RESEARCH.md
@.planning/phases/10-asset-browser-integration/10-01-SUMMARY.md

@lineage-ui/src/components/common/Pagination.tsx
@lineage-ui/src/components/domain/AssetBrowser/AssetBrowser.tsx
@lineage-ui/src/components/domain/AssetBrowser/AssetBrowser.test.tsx
@lineage-ui/src/api/hooks/useOpenLineage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add column pagination to DatasetItem component</name>
  <files>lineage-ui/src/components/domain/AssetBrowser/AssetBrowser.tsx</files>
  <action>
Add pagination to the column/field list within expanded datasets:

**1. Add pagination state to DatasetItem:**
```typescript
function DatasetItem({ dataset, isExpanded, onToggle }: DatasetItemProps) {
  const [fieldOffset, setFieldOffset] = useState(0);
  const FIELD_LIMIT = 100;

  // Fetch dataset with fields when expanded
  const { data: datasetWithFields } = useOpenLineageDataset(isExpanded ? dataset.id : '', {
    enabled: isExpanded,
  });
  const allFields = datasetWithFields?.fields || [];

  // Paginate fields
  const paginatedFields = allFields.slice(fieldOffset, fieldOffset + FIELD_LIMIT);
  const totalFields = allFields.length;
  // ... rest of component
```

**2. Reset field pagination when dataset changes:**
```typescript
// Reset pagination when dataset changes
useEffect(() => {
  setFieldOffset(0);
}, [dataset.id]);
```

**3. Update field rendering to use paginated list:**
Replace:
```typescript
fields
  .sort((a, b) => a.ordinalPosition - b.ordinalPosition)
  .map((field) => ...)
```
With:
```typescript
paginatedFields
  .sort((a, b) => a.ordinalPosition - b.ordinalPosition)
  .map((field) => ...)
```

**4. Add pagination controls after field list:**
After the field list `</ul>` inside the expanded section (but within the `{isExpanded && ...}` block), add:
```typescript
{/* Field pagination - always visible per CONTEXT.md */}
<div className="ml-4 mt-2 flex justify-center">
  <Pagination
    totalCount={totalFields}
    limit={FIELD_LIMIT}
    offset={fieldOffset}
    onPageChange={setFieldOffset}
    showFirstLast={true}
    showPageInfo={true}
  />
</div>
```

**Key notes:**
- Fields are fetched via useOpenLineageDataset when expanded
- The API returns all fields (no server-side pagination), so client-side slicing is appropriate
- Per CONTEXT.md: Pagination always visible, bottom placement, centered
  </action>
  <verify>
1. `cd /Users/Daniel.Tehan/Code/lineage/lineage-ui && npx tsc --noEmit` - No TypeScript errors
2. Visual: Pagination appears below field list when dataset is expanded
  </verify>
  <done>
- Pagination renders below field/column list when dataset expanded
- Pagination resets to page 1 when switching to different dataset
- Field navigation works via Next/Previous buttons
  </done>
</task>

<task type="auto">
  <name>Task 2: Update AssetBrowser tests to use OpenLineage hooks</name>
  <files>lineage-ui/src/components/domain/AssetBrowser/AssetBrowser.test.tsx</files>
  <action>
Rewrite the test file to mock OpenLineage hooks instead of v1 hooks, and add pagination tests.

**1. Update imports:**
Replace:
```typescript
import * as useAssetsModule from '../../../api/hooks/useAssets';
vi.mock('../../../api/hooks/useAssets');
```
With:
```typescript
import * as useOpenLineageModule from '../../../api/hooks/useOpenLineage';
vi.mock('../../../api/hooks/useOpenLineage');
```

**2. Create mock data matching OpenLineage types:**
```typescript
const mockNamespaces = {
  namespaces: [
    { id: 'ns-1', uri: 'teradata://localhost', specVersion: '1.0', createdAt: '2024-01-01' }
  ]
};

const mockDatasets = [
  { id: 'ds-1', namespace: 'ns-1', name: 'sales_db.orders', sourceType: 'table', createdAt: '2024-01-01', updatedAt: '2024-01-01' },
  { id: 'ds-2', namespace: 'ns-1', name: 'sales_db.customers', sourceType: 'table', createdAt: '2024-01-01', updatedAt: '2024-01-01' },
  { id: 'ds-3', namespace: 'ns-1', name: 'analytics_db.reports', sourceType: 'view', createdAt: '2024-01-01', updatedAt: '2024-01-01' },
];

const mockDatasetWithFields = {
  id: 'ds-1',
  namespace: 'ns-1',
  name: 'sales_db.orders',
  sourceType: 'table',
  createdAt: '2024-01-01',
  updatedAt: '2024-01-01',
  fields: [
    { id: 'f-1', name: 'order_id', type: 'INTEGER', ordinalPosition: 1, nullable: false },
    { id: 'f-2', name: 'customer_id', type: 'INTEGER', ordinalPosition: 2, nullable: false },
  ]
};
```

**3. Update beforeEach to mock OpenLineage hooks:**
```typescript
beforeEach(() => {
  vi.clearAllMocks();

  // Mock useOpenLineageNamespaces
  vi.mocked(useOpenLineageModule.useOpenLineageNamespaces).mockReturnValue({
    data: mockNamespaces,
    isLoading: false,
    isError: false,
    error: null,
    isSuccess: true,
  } as ReturnType<typeof useOpenLineageModule.useOpenLineageNamespaces>);

  // Mock useOpenLineageDatasets
  vi.mocked(useOpenLineageModule.useOpenLineageDatasets).mockReturnValue({
    data: { datasets: mockDatasets, total: mockDatasets.length },
    isLoading: false,
    isFetching: false,
    isError: false,
    error: null,
    isSuccess: true,
  } as ReturnType<typeof useOpenLineageModule.useOpenLineageDatasets>);

  // Mock useOpenLineageDataset
  vi.mocked(useOpenLineageModule.useOpenLineageDataset).mockReturnValue({
    data: undefined,
    isLoading: false,
    isError: false,
    error: null,
    isSuccess: false,
  } as ReturnType<typeof useOpenLineageModule.useOpenLineageDataset>);

  // Remove or update useLineageStore mock if not needed
});
```

**4. Update test cases to match OpenLineage behavior:**

For TC-COMP-001 (Initial Render):
- Test loading state by setting `isLoading: true` on useOpenLineageNamespaces or useOpenLineageDatasets
- Test database list shows database names extracted from dataset names (sales_db, analytics_db)

For TC-COMP-002 (Database Expansion):
- Datasets are grouped by database name client-side
- Clicking database name toggles expanded state
- Tables (datasets) for that database are shown

For TC-COMP-003 (Table Expansion):
- Clicking expand button on dataset shows fields
- Mock useOpenLineageDataset to return fields when that dataset ID is queried

For TC-COMP-032a (View Visual Distinction):
- Verify sourceType determines icon (table, view, materialized_view)

**5. Add new pagination tests (TC-COMP-PAGE):**
```typescript
describe('TC-COMP-PAGE: Pagination', () => {
  it('shows pagination controls below database list', () => {
    vi.mocked(useOpenLineageModule.useOpenLineageDatasets).mockReturnValue({
      data: {
        datasets: mockDatasets,
        total: mockDatasets.length,
        pagination: { total_count: 250, limit: 100, offset: 0, has_next: true }
      },
      isLoading: false,
      isFetching: false,
      isError: false,
      error: null,
      isSuccess: true,
    } as ReturnType<typeof useOpenLineageModule.useOpenLineageDatasets>);

    render(<AssetBrowser />);

    // Pagination always visible per CONTEXT.md
    expect(screen.getByTestId('pagination-info')).toBeInTheDocument();
    expect(screen.getByTestId('pagination-prev')).toBeInTheDocument();
    expect(screen.getByTestId('pagination-next')).toBeInTheDocument();
  });

  it('calls useOpenLineageDatasets with updated offset when clicking next', async () => {
    const user = userEvent.setup();

    vi.mocked(useOpenLineageModule.useOpenLineageDatasets).mockReturnValue({
      data: {
        datasets: mockDatasets,
        total: 250,
        pagination: { total_count: 250, limit: 100, offset: 0, has_next: true }
      },
      isLoading: false,
      isFetching: false,
      isError: false,
      error: null,
      isSuccess: true,
    } as ReturnType<typeof useOpenLineageModule.useOpenLineageDatasets>);

    render(<AssetBrowser />);

    // Initial call with offset 0
    expect(useOpenLineageModule.useOpenLineageDatasets).toHaveBeenLastCalledWith(
      'ns-1',
      { limit: 100, offset: 0 }
    );

    // Click next
    await user.click(screen.getByTestId('pagination-next'));

    // Should be called with offset 100
    await waitFor(() => {
      expect(useOpenLineageModule.useOpenLineageDatasets).toHaveBeenLastCalledWith(
        'ns-1',
        { limit: 100, offset: 100 }
      );
    });
  });
});
```

**6. Remove useLineageStore mock if not needed:**
The current tests mock useLineageStore for setSelectedAssetId, but the OpenLineage-based AssetBrowser uses navigation instead. Check if the store is still used and remove unnecessary mocks.

**Key implementation notes:**
- Ensure all existing test case IDs (TC-COMP-001, TC-COMP-002, etc.) are preserved
- Update assertions to match OpenLineage data structure
- Add data-testid attributes to component if needed for testing
  </action>
  <verify>
1. `cd /Users/Daniel.Tehan/Code/lineage/lineage-ui && npm test -- --run AssetBrowser` - All tests pass
2. No TypeScript errors in test file
  </verify>
  <done>
- Test file mocks OpenLineage hooks (not v1 hooks)
- All existing test cases updated and passing
- New pagination test cases added and passing
- Test coverage verifies pagination at all three levels
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd lineage-ui && npx tsc --noEmit`
2. All unit tests pass: `cd lineage-ui && npm test -- --run AssetBrowser`
3. Visual verification: Pagination visible at all three levels (databases, tables, columns)
4. Pagination reset verified when switching databases or tables
</verification>

<success_criteria>
1. Column/field pagination works when dataset is expanded
2. Pagination resets to page 1 when switching tables
3. All AssetBrowser unit tests pass (updated to use OpenLineage mocks)
4. TypeScript compiles without errors
5. Pagination visible at all three levels: database list, table list, column list
</success_criteria>

<output>
After completion, create `.planning/phases/10-asset-browser-integration/10-02-SUMMARY.md`
</output>
