---
phase: 10-asset-browser-integration
plan: 03
type: execute
wave: 2
depends_on: ["10-02"]
files_modified:
  - lineage-ui/src/components/domain/AssetBrowser/AssetBrowser.test.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate through database pages using pagination controls"
    - "User can navigate through table pages within an expanded database"
    - "User can navigate through column pages within an expanded table"
    - "Pagination controls display correct count information at all levels"
  artifacts:
    - path: "lineage-ui/src/components/domain/AssetBrowser/AssetBrowser.test.tsx"
      provides: "Pagination test coverage for AssetBrowser"
      contains: "TC-COMP-PAGE"
  key_links:
    - from: "AssetBrowser.test.tsx"
      to: "Pagination component"
      via: "test assertions"
      pattern: "pagination-(prev|next|info)"
---

<objective>
Add comprehensive pagination test coverage for AssetBrowser at all three levels.

Purpose: Verify pagination behavior at database, table, and column levels through automated tests. This completes the test coverage for the pagination feature.

Output: Passing test suite with pagination coverage at all three levels.
</objective>

<execution_context>
@/Users/Daniel.Tehan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Daniel.Tehan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-asset-browser-integration/10-CONTEXT.md
@.planning/phases/10-asset-browser-integration/10-01-SUMMARY.md
@.planning/phases/10-asset-browser-integration/10-02-SUMMARY.md

@lineage-ui/src/components/common/Pagination.tsx
@lineage-ui/src/components/domain/AssetBrowser/AssetBrowser.tsx
@lineage-ui/src/components/domain/AssetBrowser/AssetBrowser.test.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pagination test coverage for all three levels</name>
  <files>lineage-ui/src/components/domain/AssetBrowser/AssetBrowser.test.tsx</files>
  <action>
Add comprehensive pagination tests for database, table, and column levels.

**Add new test suite TC-COMP-PAGE at the end of the test file:**

```typescript
// TC-COMP-PAGE: AssetBrowser Pagination
describe('TC-COMP-PAGE: Pagination', () => {
  describe('Database pagination', () => {
    it('shows pagination controls below database list (always visible per CONTEXT.md)', () => {
      // Default mock has 2 databases (sales_db, analytics_db)
      render(<AssetBrowser />);

      // Pagination always visible per CONTEXT.md
      expect(screen.getByTestId('pagination-info')).toBeInTheDocument();
      expect(screen.getByTestId('pagination-prev')).toBeInTheDocument();
      expect(screen.getByTestId('pagination-next')).toBeInTheDocument();
    });

    it('displays correct database count in pagination', () => {
      render(<AssetBrowser />);

      // With default mock: 2 databases (sales_db, analytics_db)
      expect(screen.getByText(/Showing 1-2 of 2/)).toBeInTheDocument();
    });

    it('navigates to next page of databases when clicking next', async () => {
      const user = userEvent.setup();

      // Create 150 datasets across many databases to test pagination
      const manyDatasets = Array.from({ length: 150 }, (_, i) => ({
        id: `ds-${i}`,
        namespace: 'ns-1',
        name: `db_${i}.table_${i}`,
        sourceType: 'table',
        createdAt: '2024-01-01',
        updatedAt: '2024-01-01',
      }));

      vi.mocked(useOpenLineageModule.useOpenLineageDatasets).mockReturnValue({
        data: { datasets: manyDatasets, total: manyDatasets.length },
        isLoading: false,
        isFetching: false,
        isError: false,
        error: null,
        isSuccess: true,
      } as ReturnType<typeof useOpenLineageModule.useOpenLineageDatasets>);

      render(<AssetBrowser />);

      // Should show first 100 databases
      expect(screen.getByText(/Showing 1-100 of 150/)).toBeInTheDocument();
      expect(screen.getByText('db_0')).toBeInTheDocument();
      expect(screen.queryByText('db_100')).not.toBeInTheDocument();

      // Click next
      await user.click(screen.getByTestId('pagination-next'));

      // Should now show databases 101-150
      await waitFor(() => {
        expect(screen.getByText(/Showing 101-150 of 150/)).toBeInTheDocument();
        expect(screen.getByText('db_100')).toBeInTheDocument();
        expect(screen.queryByText('db_0')).not.toBeInTheDocument();
      });
    });
  });

  describe('Table pagination within database', () => {
    it('shows pagination controls below table list when database expanded', async () => {
      const user = userEvent.setup();
      render(<AssetBrowser />);

      // Expand database
      const chevrons = screen.getAllByRole('button', { name: /expand|collapse/i });
      await user.click(chevrons[0]);

      // Wait for tables to appear
      await waitFor(() => {
        expect(screen.getByText('orders')).toBeInTheDocument();
      });

      // Should have pagination for tables (look for second pagination in DOM)
      const paginationInfos = screen.getAllByTestId('pagination-info');
      expect(paginationInfos.length).toBeGreaterThanOrEqual(2); // db + table level
    });

    it('resets table pagination when switching databases', async () => {
      const user = userEvent.setup();

      // Create datasets with 150 tables in one database
      const manyTablesDatasets = [
        ...Array.from({ length: 150 }, (_, i) => ({
          id: `ds-sales-${i}`,
          namespace: 'ns-1',
          name: `sales_db.table_${i}`,
          sourceType: 'table',
          createdAt: '2024-01-01',
          updatedAt: '2024-01-01',
        })),
        { id: 'ds-analytics-1', namespace: 'ns-1', name: 'analytics_db.report', sourceType: 'table', createdAt: '2024-01-01', updatedAt: '2024-01-01' },
      ];

      vi.mocked(useOpenLineageModule.useOpenLineageDatasets).mockReturnValue({
        data: { datasets: manyTablesDatasets, total: manyTablesDatasets.length },
        isLoading: false,
        isFetching: false,
        isError: false,
        error: null,
        isSuccess: true,
      } as ReturnType<typeof useOpenLineageModule.useOpenLineageDatasets>);

      render(<AssetBrowser />);

      // Expand sales_db
      await user.click(screen.getByText('sales_db'));

      await waitFor(() => {
        expect(screen.getByText('table_0')).toBeInTheDocument();
      });

      // Navigate to page 2 of tables
      const tablePaginationNext = screen.getAllByTestId('pagination-next')[1]; // Second pagination is for tables
      await user.click(tablePaginationNext);

      await waitFor(() => {
        expect(screen.getByText('table_100')).toBeInTheDocument();
      });

      // Collapse sales_db
      await user.click(screen.getByText('sales_db'));

      // Expand analytics_db
      await user.click(screen.getByText('analytics_db'));

      await waitFor(() => {
        expect(screen.getByText('report')).toBeInTheDocument();
      });

      // Re-expand sales_db - pagination should reset to page 1
      await user.click(screen.getByText('analytics_db')); // collapse
      await user.click(screen.getByText('sales_db')); // expand

      await waitFor(() => {
        expect(screen.getByText('table_0')).toBeInTheDocument(); // Back at page 1
      });
    });
  });

  describe('Column pagination within table', () => {
    it('shows pagination controls below column list when table expanded', async () => {
      const user = userEvent.setup();

      // Mock useOpenLineageDataset to return fields when called
      vi.mocked(useOpenLineageModule.useOpenLineageDataset).mockReturnValue({
        data: mockDatasetWithFields,
        isLoading: false,
        isError: false,
        error: null,
        isSuccess: true,
      } as ReturnType<typeof useOpenLineageModule.useOpenLineageDataset>);

      render(<AssetBrowser />);

      // Expand database
      await user.click(screen.getByText('sales_db'));

      await waitFor(() => {
        expect(screen.getByText('orders')).toBeInTheDocument();
      });

      // Expand table (click chevron, not the table name which navigates)
      const expandButtons = screen.getAllByRole('button', { name: /expand|collapse/i });
      // Find the one next to orders table
      const ordersExpandBtn = expandButtons.find(btn =>
        btn.closest('li')?.textContent?.includes('orders')
      );
      if (ordersExpandBtn) {
        await user.click(ordersExpandBtn);
      }

      await waitFor(() => {
        expect(screen.getByText('order_id')).toBeInTheDocument();
      });

      // Should have pagination for columns
      const paginationInfos = screen.getAllByTestId('pagination-info');
      expect(paginationInfos.length).toBeGreaterThanOrEqual(3); // db + table + column level
    });

    it('navigates through column pages when table has many columns', async () => {
      const user = userEvent.setup();

      // Create dataset with 150 fields
      const manyFieldsDataset = {
        ...mockDatasetWithFields,
        fields: Array.from({ length: 150 }, (_, i) => ({
          id: `f-${i}`,
          name: `column_${i}`,
          type: 'VARCHAR',
          ordinalPosition: i + 1,
          nullable: true,
        })),
      };

      vi.mocked(useOpenLineageModule.useOpenLineageDataset).mockReturnValue({
        data: manyFieldsDataset,
        isLoading: false,
        isError: false,
        error: null,
        isSuccess: true,
      } as ReturnType<typeof useOpenLineageModule.useOpenLineageDataset>);

      render(<AssetBrowser />);

      // Expand database
      await user.click(screen.getByText('sales_db'));

      await waitFor(() => {
        expect(screen.getByText('orders')).toBeInTheDocument();
      });

      // Expand table
      const expandButtons = screen.getAllByRole('button', { name: /expand|collapse/i });
      const ordersExpandBtn = expandButtons.find(btn =>
        btn.closest('li')?.textContent?.includes('orders')
      );
      if (ordersExpandBtn) {
        await user.click(ordersExpandBtn);
      }

      await waitFor(() => {
        expect(screen.getByText('column_0')).toBeInTheDocument();
        expect(screen.queryByText('column_100')).not.toBeInTheDocument();
      });

      // Click next on column pagination (should be the last pagination control)
      const paginationNextButtons = screen.getAllByTestId('pagination-next');
      const columnPaginationNext = paginationNextButtons[paginationNextButtons.length - 1];
      await user.click(columnPaginationNext);

      await waitFor(() => {
        expect(screen.getByText('column_100')).toBeInTheDocument();
        expect(screen.queryByText('column_0')).not.toBeInTheDocument();
      });
    });
  });
});
```

**Key implementation notes:**
- Tests use data-testid attributes from Pagination component (pagination-info, pagination-prev, pagination-next)
- Per CONTEXT.md: Pagination is ALWAYS visible, even for single pages
- Tests verify client-side pagination behavior (slice-based, not API-based)
- Tests check pagination reset behavior when switching contexts
  </action>
  <verify>
1. `cd /Users/Daniel.Tehan/Code/lineage/lineage-ui && npm test -- --run AssetBrowser` - All tests pass including new pagination tests
2. `cd /Users/Daniel.Tehan/Code/lineage/lineage-ui && npx tsc --noEmit` - No TypeScript errors
  </verify>
  <done>
- TC-COMP-PAGE test suite added with coverage for all three pagination levels
- Database pagination tests pass
- Table pagination tests pass (including reset behavior)
- Column pagination tests pass (including navigation)
- All existing tests continue to pass
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd lineage-ui && npx tsc --noEmit`
2. All tests pass: `cd lineage-ui && npm test -- --run AssetBrowser`
3. Test coverage includes:
   - Database pagination visibility and navigation
   - Table pagination visibility and reset on database switch
   - Column pagination visibility and navigation
</verification>

<success_criteria>
1. TC-COMP-PAGE test suite exists with tests for all three pagination levels
2. All pagination tests pass
3. All existing tests continue to pass
4. TypeScript compiles without errors
5. Test coverage verifies "always visible" pagination per CONTEXT.md
</success_criteria>

<output>
After completion, create `.planning/phases/10-asset-browser-integration/10-03-SUMMARY.md`
</output>
