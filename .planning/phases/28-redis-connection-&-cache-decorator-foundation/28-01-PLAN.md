---
phase: 28-redis-connection-cache-decorator-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lineage-api/go.mod
  - lineage-api/go.sum
  - lineage-api/cmd/server/main.go
autonomous: true

must_haves:
  truths:
    - "go-redis dependency is at v9.7.3 with CVE-2025-29923 fix"
    - "main.go creates a Redis client from environment variables and fails fast if Redis is unreachable"
    - "main.go wraps the Teradata OpenLineageRepository with CachedOpenLineageRepository decorator"
    - "Service and handler code is unchanged -- decorator is injected transparently"
    - "Redis client connection is closed on server shutdown via defer"
  artifacts:
    - path: "lineage-api/go.mod"
      provides: "go-redis v9.7.3 dependency"
      contains: "github.com/redis/go-redis/v9 v9.7.3"
    - path: "lineage-api/cmd/server/main.go"
      provides: "Redis wiring with fail-fast and decorator injection"
      contains: "NewCachedOpenLineageRepository"
  key_links:
    - from: "lineage-api/cmd/server/main.go"
      to: "internal/adapter/outbound/redis"
      via: "import and NewCacheRepository call"
      pattern: "redis\\.NewCacheRepository"
    - from: "lineage-api/cmd/server/main.go"
      to: "internal/adapter/outbound/redis"
      via: "NewCachedOpenLineageRepository wrapping olRepo"
      pattern: "redis\\.NewCachedOpenLineageRepository"
---

<objective>
Upgrade go-redis to v9.7.3 (CVE fix) and wire Redis into main.go with fail-fast behavior and cache decorator injection.

Purpose: Establish the Redis connection infrastructure so that Plan 28-02's CachedOpenLineageRepository decorator has a working Redis client to use. This plan handles the dependency upgrade and the wiring in main.go. The decorator itself does not exist yet -- main.go will reference it, and Plan 28-02 will create it. This plan creates a compilable-but-not-yet-buildable state (the import of NewCachedOpenLineageRepository will fail until Plan 28-02 creates that file).

IMPORTANT: Because `NewCachedOpenLineageRepository` does not exist until Plan 28-02, this plan should wire main.go with the decorator call but understand the project will NOT compile until Plan 28-02 completes. The verify step confirms the go-redis upgrade and reviews the main.go diff -- it does NOT require `go build` to pass.

Output: Updated go.mod/go.sum with go-redis v9.7.3, updated main.go with Redis client creation, fail-fast, and decorator wiring.
</objective>

<execution_context>
@/Users/Daniel.Tehan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Daniel.Tehan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-redis-connection-&-cache-decorator-foundation/28-CONTEXT.md
@.planning/phases/28-redis-connection-&-cache-decorator-foundation/28-RESEARCH.md

Key source files:
@lineage-api/go.mod
@lineage-api/cmd/server/main.go
@lineage-api/internal/adapter/outbound/redis/cache.go
@lineage-api/internal/infrastructure/config/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade go-redis from v9.4.0 to v9.7.3</name>
  <files>lineage-api/go.mod, lineage-api/go.sum</files>
  <action>
Run from the `lineage-api/` directory:

```bash
cd /Users/Daniel.Tehan/Code/lineage/lineage-api
go get github.com/redis/go-redis/v9@v9.7.3
go mod tidy
```

After running, verify go.mod shows `github.com/redis/go-redis/v9 v9.7.3` (not v9.4.0, not v9.7.0).

WHY v9.7.3 specifically: v9.7.0 contains CVE-2025-29923 (GO-2025-3540) -- out-of-order responses when CLIENT SETINFO times out. The fix was backported to v9.7.3. Do NOT use v9.7.0.
  </action>
  <verify>
Run: `grep 'go-redis/v9' /Users/Daniel.Tehan/Code/lineage/lineage-api/go.mod` -- must show v9.7.3.
Run: `cd /Users/Daniel.Tehan/Code/lineage/lineage-api && go mod verify` -- must show "all modules verified".
  </verify>
  <done>go.mod shows go-redis v9.7.3. go.sum updated. `go mod verify` passes.</done>
</task>

<task type="auto">
  <name>Task 2: Wire Redis client and decorator in main.go</name>
  <files>lineage-api/cmd/server/main.go</files>
  <action>
Modify `cmd/server/main.go` to:

1. Add import for the redis adapter package:
   ```go
   redisAdapter "github.com/lineage-api/internal/adapter/outbound/redis"
   ```

2. After the Teradata connection block (after `defer db.Close()`), add Redis client creation with fail-fast:
   ```go
   // Redis cache -- fail fast if unavailable (Phase 30 adds graceful degradation)
   cacheRepo, err := redisAdapter.NewCacheRepository(cfg.Redis)
   if err != nil {
       log.Fatalf("Failed to connect to Redis: %v", err)
   }
   defer cacheRepo.Close()
   ```

3. Replace the existing OpenLineage repository wiring block. The CURRENT code (lines ~58-61):
   ```go
   olRepo := teradata.NewOpenLineageRepository(db)
   olService := application.NewOpenLineageService(olRepo)
   olHandler := httpAdapter.NewOpenLineageHandler(olService)
   ```

   Replace with:
   ```go
   olRepo := teradata.NewOpenLineageRepository(db)
   cachedOLRepo := redisAdapter.NewCachedOpenLineageRepository(olRepo, cacheRepo, 300) // 5-min TTL
   olService := application.NewOpenLineageService(cachedOLRepo)
   olHandler := httpAdapter.NewOpenLineageHandler(olService)
   ```

   WHY 300 seconds (5 min) TTL: Conservative default that reduces staleness risk while still providing significant benefit for expensive lineage queries (150-500ms). Phase 29 will make this configurable via CACHE_TTL_LINEAGE env var.

   WHY `cachedOLRepo` not `olRepo`: The decorator wraps the Teradata repo and is passed to the service. The service code is unchanged (CACHE-05). It receives a `domain.OpenLineageRepository` interface -- it doesn't know or care that caching is happening.

IMPORTANT: The `redisAdapter.NewCachedOpenLineageRepository` function does NOT exist yet. It will be created in Plan 28-02. This is intentional -- this plan establishes the wiring, Plan 28-02 creates the decorator. The code will NOT compile until both plans complete.
  </action>
  <verify>
Review the diff of main.go to confirm:
1. Redis import added (`redisAdapter "github.com/lineage-api/internal/adapter/outbound/redis"`)
2. `cacheRepo` created from `cfg.Redis` with `log.Fatalf` on failure
3. `defer cacheRepo.Close()` present
4. `NewCachedOpenLineageRepository(olRepo, cacheRepo, 300)` called
5. `cachedOLRepo` passed to `NewOpenLineageService` (not bare `olRepo`)
6. No changes to service or handler construction
  </verify>
  <done>main.go imports redis adapter, creates Redis client with fail-fast, wraps olRepo with cached decorator, passes decorator to service. Service and handler code unchanged.</done>
</task>

</tasks>

<verification>
- go.mod contains `github.com/redis/go-redis/v9 v9.7.3`
- `go mod verify` passes (module integrity)
- main.go has Redis wiring with fail-fast (`log.Fatalf` on connection failure)
- main.go passes cached decorator to service, not bare Teradata repo
- No changes to any file in `internal/application/` or `internal/adapter/inbound/http/`
</verification>

<success_criteria>
1. go-redis upgraded from v9.4.0 to v9.7.3 (CVE-2025-29923 patched)
2. main.go creates Redis client from cfg.Redis and exits on connection failure
3. main.go wraps Teradata olRepo with CachedOpenLineageRepository decorator
4. Service receives decorator transparently (no service code changes)
5. Redis connection is closed on shutdown via defer
</success_criteria>

<output>
After completion, create `.planning/phases/28-redis-connection-&-cache-decorator-foundation/28-01-SUMMARY.md`
</output>
