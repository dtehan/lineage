---
phase: 28-redis-connection-cache-decorator-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lineage-api/go.mod
  - lineage-api/go.sum
  - lineage-api/cmd/server/main.go
autonomous: true

must_haves:
  truths:
    - "go-redis dependency is at v9.7.3 with CVE-2025-29923 fix"
    - "main.go creates a Redis client from environment variables and fails fast if Redis is unreachable"
    - "Redis client connection is closed on server shutdown via defer"
    - "Project compiles successfully after this plan completes"
  artifacts:
    - path: "lineage-api/go.mod"
      provides: "go-redis v9.7.3 dependency"
      contains: "github.com/redis/go-redis/v9 v9.7.3"
    - path: "lineage-api/cmd/server/main.go"
      provides: "Redis client creation with fail-fast"
      contains: "NewCacheRepository"
  key_links:
    - from: "lineage-api/cmd/server/main.go"
      to: "internal/adapter/outbound/redis"
      via: "import and NewCacheRepository call"
      pattern: "redis\\.NewCacheRepository"
---

<objective>
Upgrade go-redis to v9.7.3 (CVE fix) and wire Redis client creation into main.go with fail-fast behavior.

Purpose: Establish the Redis connection infrastructure so that Plan 28-02 can create the CachedOpenLineageRepository decorator and wire it into the service layer. This plan ONLY handles the dependency upgrade and Redis client creation -- it does NOT touch the OpenLineageRepository wiring (that moves to Plan 28-02 to ensure each plan leaves the codebase in a compilable state).

Output: Updated go.mod/go.sum with go-redis v9.7.3, updated main.go with Redis client creation and fail-fast error handling. The codebase compiles after this plan completes.
</objective>

<execution_context>
@/Users/Daniel.Tehan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Daniel.Tehan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-redis-connection-&-cache-decorator-foundation/28-CONTEXT.md
@.planning/phases/28-redis-connection-&-cache-decorator-foundation/28-RESEARCH.md

Key source files:
@lineage-api/go.mod
@lineage-api/cmd/server/main.go
@lineage-api/internal/adapter/outbound/redis/cache.go
@lineage-api/internal/infrastructure/config/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade go-redis from v9.4.0 to v9.7.3</name>
  <files>lineage-api/go.mod, lineage-api/go.sum</files>
  <action>
Run from the `lineage-api/` directory:

```bash
cd /Users/Daniel.Tehan/Code/lineage/lineage-api
go get github.com/redis/go-redis/v9@v9.7.3
go mod tidy
```

After running, verify go.mod shows `github.com/redis/go-redis/v9 v9.7.3` (not v9.4.0, not v9.7.0).

WHY v9.7.3 specifically: v9.7.0 contains CVE-2025-29923 (GO-2025-3540) -- out-of-order responses when CLIENT SETINFO times out. The fix was backported to v9.7.3. Do NOT use v9.7.0.
  </action>
  <verify>
Run: `grep 'go-redis/v9' /Users/Daniel.Tehan/Code/lineage/lineage-api/go.mod` -- must show v9.7.3.
Run: `cd /Users/Daniel.Tehan/Code/lineage/lineage-api && go mod verify` -- must show "all modules verified".
  </verify>
  <done>go.mod shows go-redis v9.7.3. go.sum updated. `go mod verify` passes.</done>
</task>

<task type="auto">
  <name>Task 2: Create Redis client with fail-fast in main.go</name>
  <files>lineage-api/cmd/server/main.go</files>
  <action>
Modify `cmd/server/main.go` to create a Redis client that fails fast if Redis is unreachable. Do NOT wire the decorator yet -- that happens in Plan 28-02 after the decorator file exists.

1. Add import for the redis adapter package:
   ```go
   redisAdapter "github.com/lineage-api/internal/adapter/outbound/redis"
   ```

2. After the Teradata connection block (after `defer db.Close()`), add Redis client creation with fail-fast:
   ```go
   // Redis cache -- fail fast if unavailable (Phase 30 adds graceful degradation)
   cacheRepo, err := redisAdapter.NewCacheRepository(cfg.Redis)
   if err != nil {
       log.Fatalf("Failed to connect to Redis: %v", err)
   }
   defer cacheRepo.Close()
   ```

3. DO NOT modify the OpenLineageRepository wiring block. Leave it exactly as-is:
   ```go
   olRepo := teradata.NewOpenLineageRepository(db)
   olService := application.NewOpenLineageService(olRepo)
   olHandler := httpAdapter.NewOpenLineageHandler(olService)
   ```
   The decorator wrapping will be added in Plan 28-02, Task 3 after the decorator file exists.

WHY fail-fast (log.Fatalf): Phase 28 requires Redis to be running. Phase 30 will add graceful degradation with NoOpCache fallback. For now, if Redis is down, the server should not start.

NOTE: The `cacheRepo` variable will appear unused until Plan 28-02 wires the decorator. To avoid a Go compilation error for an unused variable, add a blank identifier usage after the defer:
   ```go
   _ = cacheRepo // Used by CachedOpenLineageRepository in Plan 28-02
   ```
   Plan 28-02 will remove this blank identifier when it adds the decorator wiring.
  </action>
  <verify>
Run: `cd /Users/Daniel.Tehan/Code/lineage/lineage-api && go build ./cmd/server/` -- must compile successfully.
Run: `grep '_ = cacheRepo' /Users/Daniel.Tehan/Code/lineage/lineage-api/cmd/server/main.go` -- must be present to avoid unused variable compile error.
Review the diff of main.go to confirm:
1. Redis import added (`redisAdapter "github.com/lineage-api/internal/adapter/outbound/redis"`)
2. `cacheRepo` created from `cfg.Redis` with `log.Fatalf` on failure
3. `defer cacheRepo.Close()` present
4. `_ = cacheRepo` blank identifier present
5. OpenLineageRepository wiring is UNCHANGED (still `olService := application.NewOpenLineageService(olRepo)`)
6. No changes to service or handler construction
  </verify>
  <done>main.go imports redis adapter, creates Redis client with fail-fast, defers Close, includes blank identifier for unused variable. OpenLineage wiring is unchanged. Project compiles.</done>
</task>

</tasks>

<verification>
- go.mod contains `github.com/redis/go-redis/v9 v9.7.3`
- `go mod verify` passes (module integrity)
- main.go has Redis client creation with fail-fast (`log.Fatalf` on connection failure)
- main.go has `_ = cacheRepo` to prevent unused variable error
- main.go OpenLineage wiring is UNCHANGED (no reference to NewCachedOpenLineageRepository)
- `go build ./cmd/server/` compiles successfully
- No changes to any file in `internal/application/` or `internal/adapter/inbound/http/`
</verification>

<success_criteria>
1. go-redis upgraded from v9.4.0 to v9.7.3 (CVE-2025-29923 patched)
2. main.go creates Redis client from cfg.Redis and exits on connection failure
3. Redis connection is closed on shutdown via defer
4. Blank identifier `_ = cacheRepo` present to prevent unused variable compile error
5. Project compiles successfully -- no broken intermediate state
6. OpenLineage repository wiring untouched (decorator wiring deferred to Plan 28-02)
</success_criteria>

<output>
After completion, create `.planning/phases/28-redis-connection-&-cache-decorator-foundation/28-01-SUMMARY.md`
</output>
