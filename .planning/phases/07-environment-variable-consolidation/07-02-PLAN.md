---
phase: 07-environment-variable-consolidation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lineage-api/internal/infrastructure/config/config.go
autonomous: true

must_haves:
  truths:
    - "TERADATA_* variables work as primary for Go server"
    - "TD_* variables work as legacy fallback for Go server"
    - "API_PORT controls Go server port with PORT as fallback"
    - "Existing .env files with TD_* or PORT still work (backwards compatible)"
  artifacts:
    - path: "lineage-api/internal/infrastructure/config/config.go"
      provides: "Go config with TERADATA_* primary, TD_*/PORT fallbacks"
      contains: "bindLegacyFallback"
  key_links:
    - from: "lineage-api/internal/infrastructure/config/config.go"
      to: "viper environment bindings"
      via: "bindLegacyFallback helper"
      pattern: "bindLegacyFallback.*TD_"
---

<objective>
Add TD_* legacy fallback support and API_PORT to Go server configuration.

Purpose: Enable the Go server to accept both TERADATA_* (primary) and TD_* (legacy) variable names, and use API_PORT for server port with PORT as fallback.
Output: Updated config.go with Viper-based fallback bindings.
</objective>

<execution_context>
@/Users/Daniel.Tehan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Daniel.Tehan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-environment-variable-consolidation/07-RESEARCH.md

# Source file to modify
@lineage-api/internal/infrastructure/config/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bindLegacyFallback helper function</name>
  <files>lineage-api/internal/infrastructure/config/config.go</files>
  <action>
Add a helper function that binds legacy environment variable names as fallbacks.

1. Add the bindLegacyFallback function after the loadDotEnv function:

```go
// bindLegacyFallback binds a legacy env var as fallback if primary is not set.
// This enables backwards compatibility with existing deployments using TD_* or PORT.
func bindLegacyFallback(primary, legacy string) {
    if os.Getenv(primary) == "" && os.Getenv(legacy) != "" {
        viper.BindEnv(primary, legacy)
    }
}
```

This function:
- Checks if the primary variable is not set (empty string)
- Checks if the legacy variable IS set (non-empty)
- If both conditions met, binds the legacy variable to the primary key in Viper

The function must be placed after loadDotEnv() and before it's used in Load().
  </action>
  <verify>
Verify file compiles: `cd /Users/Daniel.Tehan/Code/lineage/lineage-api && go build ./internal/infrastructure/config/`

Verify function exists: `grep -n "bindLegacyFallback" /Users/Daniel.Tehan/Code/lineage/lineage-api/internal/infrastructure/config/config.go`
  </verify>
  <done>
- bindLegacyFallback helper function added to config.go
- Function takes primary and legacy variable names
- Function binds legacy to primary only when primary is unset and legacy is set
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate legacy fallbacks and API_PORT into Load function</name>
  <files>lineage-api/internal/infrastructure/config/config.go</files>
  <action>
Update the Load() function to use bindLegacyFallback for TD_* variables and change PORT to API_PORT.

1. Change the default for PORT to API_PORT:
   - Change: `viper.SetDefault("PORT", "8080")`
   - To: `viper.SetDefault("API_PORT", "8080")`

2. After the viper.SetDefault calls and before building the Config struct, add legacy fallback bindings:

```go
// Legacy fallbacks - bind TD_* variables if TERADATA_* not set
bindLegacyFallback("TERADATA_HOST", "TD_HOST")
bindLegacyFallback("TERADATA_USER", "TD_USER")
bindLegacyFallback("TERADATA_PASSWORD", "TD_PASSWORD")
bindLegacyFallback("TERADATA_DATABASE", "TD_DATABASE")
bindLegacyFallback("TERADATA_PORT", "TD_PORT")
bindLegacyFallback("API_PORT", "PORT")
```

3. Update the Config struct assignment to use API_PORT:
   - Change: `Port: viper.GetString("PORT"),`
   - To: `Port: viper.GetString("API_PORT"),`

The order matters:
1. loadDotEnv() - loads .env file
2. viper.AutomaticEnv() - enables env var reading
3. viper.SetDefault() calls - set defaults
4. bindLegacyFallback() calls - set up legacy mappings
5. Build Config struct - read final values

DO NOT change any validation logic or other parts of the Load function.
  </action>
  <verify>
Build the package: `cd /Users/Daniel.Tehan/Code/lineage/lineage-api && go build ./internal/infrastructure/config/`

Run existing tests: `cd /Users/Daniel.Tehan/Code/lineage/lineage-api && go test ./internal/infrastructure/config/... -v`

Test API_PORT is used: `grep "API_PORT" /Users/Daniel.Tehan/Code/lineage/lineage-api/internal/infrastructure/config/config.go | wc -l` - should be at least 3 occurrences.

Test legacy bindings: `grep "bindLegacyFallback" /Users/Daniel.Tehan/Code/lineage/lineage-api/internal/infrastructure/config/config.go | wc -l` - should be 6 (one per TD_* variable plus PORT).
  </verify>
  <done>
- API_PORT is the primary port variable (default 8080)
- PORT is bound as fallback to API_PORT
- TD_HOST is bound as fallback to TERADATA_HOST
- TD_USER is bound as fallback to TERADATA_USER
- TD_PASSWORD is bound as fallback to TERADATA_PASSWORD
- TD_DATABASE is bound as fallback to TERADATA_DATABASE
- TD_PORT is bound as fallback to TERADATA_PORT
- Go build succeeds
- Existing tests pass
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Build the entire API:
```bash
cd /Users/Daniel.Tehan/Code/lineage/lineage-api && go build ./...
```

2. Run config tests:
```bash
cd /Users/Daniel.Tehan/Code/lineage/lineage-api && go test ./internal/infrastructure/config/... -v
```

3. Verify the changes in the code:
```bash
grep -E "(bindLegacyFallback|API_PORT)" /Users/Daniel.Tehan/Code/lineage/lineage-api/internal/infrastructure/config/config.go
```
</verification>

<success_criteria>
- [ ] bindLegacyFallback helper function exists and is correct
- [ ] API_PORT is the primary port variable with default 8080
- [ ] PORT is bound as legacy fallback to API_PORT
- [ ] All TD_* variables are bound as fallbacks to TERADATA_* variables
- [ ] Go package builds without errors
- [ ] Existing config tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-environment-variable-consolidation/07-02-SUMMARY.md`
</output>
