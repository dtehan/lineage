---
phase: 20-backend-statistics-and-ddl-api
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - lineage-api/python_server.py
  - lineage-api/internal/adapter/outbound/teradata/openlineage_repo.go
  - lineage-api/internal/domain/entities.go
  - lineage-api/internal/domain/mocks/repositories.go
  - lineage-ui/src/types/openlineage.ts
  - lineage-ui/src/components/domain/LineageGraph/DetailPanel/DDLTab.tsx
  - lineage-ui/src/components/domain/LineageGraph/DetailPanel.test.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Statistics tab displays actual row count for tables (not N/A)"
    - "DDL tab displays CREATE TABLE DDL for tables with syntax highlighting"
    - "DDL tab continues to display view SQL for views (no regression)"
    - "Row count gracefully shows N/A only when genuinely unavailable"
  artifacts:
    - path: "lineage-api/python_server.py"
      provides: "Row count fallback query and SHOW TABLE DDL for tables"
      contains: "SHOW TABLE"
    - path: "lineage-api/internal/adapter/outbound/teradata/openlineage_repo.go"
      provides: "Go backend row count fallback and SHOW TABLE DDL"
      contains: "SHOW TABLE"
    - path: "lineage-api/internal/domain/entities.go"
      provides: "TableDDL field on DatasetDDL struct"
      contains: "TableDDL"
    - path: "lineage-ui/src/types/openlineage.ts"
      provides: "tableDdl field on DatasetDDLResponse"
      contains: "tableDdl"
    - path: "lineage-ui/src/components/domain/LineageGraph/DetailPanel/DDLTab.tsx"
      provides: "Renders table DDL with syntax highlighting"
      contains: "tableDdl"
  key_links:
    - from: "python_server.py statistics endpoint"
      to: "DBC.TableStatsV"
      via: "Fallback query without IndexNumber=1 filter"
      pattern: "DBC\\.TableStatsV"
    - from: "python_server.py DDL endpoint"
      to: "Teradata SHOW TABLE"
      via: "cur.execute for tables"
      pattern: "SHOW TABLE"
    - from: "DDLTab.tsx"
      to: "DatasetDDLResponse.tableDdl"
      via: "Highlight component for table DDL"
      pattern: "data\\.tableDdl"
---

<objective>
Fix two gaps found during human UAT re-testing of Phase 20 endpoints:

1. **Row Count N/A** — Statistics tab shows "Row Count: N/A" because `DBC.TableStatsV WHERE IndexNumber = 1` returns no rows (statistics not collected or index numbering differs). Fix by removing the `IndexNumber = 1` filter and taking the maximum RowCount, which captures the primary index row count regardless of index numbering. If that still returns nothing, fall back gracefully (N/A is correct).

2. **Table DDL missing** — DDL tab shows "DDL is not available for tables" because code explicitly nulls viewSql for tables. Fix by running Teradata's `SHOW TABLE database.table` command for tables, which returns the full CREATE TABLE DDL statement. Add a `tableDdl` field to the API response and update the frontend to render it with syntax highlighting.

Purpose: Users need to see row counts for capacity planning and table DDL for understanding table structure.
Output: Working row count display and table DDL display in the detail panel.
</objective>

<execution_context>
@/Users/Daniel.Tehan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Daniel.Tehan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/20-backend-statistics-&-ddl-api/20-03-SUMMARY.md
@lineage-api/python_server.py (lines 1740-1901)
@lineage-api/internal/adapter/outbound/teradata/openlineage_repo.go (lines 810-1013)
@lineage-api/internal/domain/entities.go (lines 217-240)
@lineage-ui/src/types/openlineage.ts (lines 135-159)
@lineage-ui/src/components/domain/LineageGraph/DetailPanel/DDLTab.tsx
@lineage-ui/src/components/domain/LineageGraph/DetailPanel.test.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix row count query and add table DDL in Python and Go backends</name>
  <files>
    lineage-api/python_server.py
    lineage-api/internal/adapter/outbound/teradata/openlineage_repo.go
    lineage-api/internal/domain/entities.go
    lineage-api/internal/domain/mocks/repositories.go
  </files>
  <action>
  **Gap 1 Fix: Row Count (Python — lines 1754-1766)**

  Replace the `DBC.TableStatsV` query that filters on `IndexNumber = 1` with a query that gets the maximum RowCount across all indexes. The primary index may not be IndexNumber=1 in all Teradata configurations, and statistics may only be collected on certain indexes.

  Change the Python statistics endpoint query from:
  ```sql
  SELECT RowCount FROM DBC.TableStatsV
  WHERE DatabaseName = ? AND TableName = ? AND IndexNumber = 1
  ```
  To:
  ```sql
  SELECT MAX(RowCount) FROM DBC.TableStatsV
  WHERE DatabaseName = ? AND TableName = ?
  ```

  This removes the IndexNumber filter and uses MAX to get the highest row count from any available statistics index. If no statistics exist at all, this still returns NULL gracefully.

  **Gap 1 Fix: Row Count (Go — lines 869-883)**

  Apply the same change to the Go backend `GetDatasetStatistics` method:
  Change from:
  ```sql
  SELECT RowCount FROM DBC.TableStatsV
  WHERE DatabaseName = ? AND TableName = ? AND IndexNumber = 1
  ```
  To:
  ```sql
  SELECT MAX(RowCount) FROM DBC.TableStatsV
  WHERE DatabaseName = ? AND TableName = ?
  ```

  **Gap 2 Fix: Table DDL (Domain — entities.go line ~231)**

  Add a `TableDDL` field to the `DatasetDDL` struct:
  ```go
  type DatasetDDL struct {
      DatasetID      string            `json:"datasetId"`
      DatabaseName   string            `json:"databaseName"`
      TableName      string            `json:"tableName"`
      SourceType     string            `json:"sourceType"`
      ViewSQL        string            `json:"viewSql,omitempty"`
      TableDDL       string            `json:"tableDdl,omitempty"`    // NEW
      Truncated      bool              `json:"truncated"`
      TableComment   string            `json:"tableComment,omitempty"`
      ColumnComments map[string]string `json:"columnComments,omitempty"`
  }
  ```

  **Gap 2 Fix: Table DDL (Python — lines 1860-1865)**

  After `source_type = "VIEW" if table_kind == "V" else "TABLE"`, instead of just nulling viewSql for tables, add a block that runs `SHOW TABLE` for tables:

  Replace lines 1862-1865 (the "Only set viewSql for views" block) with:
  ```python
  # Only set viewSql for views
  if source_type != "VIEW":
      view_sql = None
      truncated = False

  # For tables, get CREATE TABLE DDL via SHOW TABLE
  table_ddl = None
  if source_type == "TABLE":
      try:
          cur.execute(f"SHOW TABLE {db_name}.{table_name}")
          ddl_rows = cur.fetchall()
          if ddl_rows:
              table_ddl = "\n".join(row[0] if isinstance(row[0], str) else str(row[0]) for row in ddl_rows).strip()
      except Exception:
          pass  # Permission or availability issue, leave tableDdl null
  ```

  Then add `"tableDdl": table_ddl,` to the result dict (after "viewSql").

  IMPORTANT: The `SHOW TABLE` command in Teradata returns the DDL as multiple rows of text. Each row contains a fragment of the CREATE TABLE statement. Concatenate all rows with newlines to get the full DDL.

  **Gap 2 Fix: Table DDL (Go — after line 979)**

  In the `GetDatasetDDL` method, after the view SQL block (after the truncation check), add table DDL retrieval for tables:

  ```go
  // For tables, get CREATE TABLE DDL via SHOW TABLE
  if strings.TrimSpace(tableKind.String) != "V" {
      showQuery := fmt.Sprintf("SHOW TABLE %s.%s", dbName, tableName)
      showRows, err := r.db.QueryContext(ctx, showQuery)
      if err != nil {
          // Log but don't fail - permission issues possible
          slog.WarnContext(ctx, "failed to get table DDL",
              "database", dbName, "table", tableName, "error", err)
      } else {
          defer showRows.Close()
          var ddlParts []string
          for showRows.Next() {
              var line string
              if err := showRows.Scan(&line); err != nil {
                  slog.WarnContext(ctx, "failed to scan DDL line",
                      "database", dbName, "table", tableName, "error", err)
                  continue
              }
              ddlParts = append(ddlParts, line)
          }
          if len(ddlParts) > 0 {
              ddl.TableDDL = strings.Join(ddlParts, "\n")
          }
      }
  }
  ```

  NOTE: The `showRows.Close()` defer is inside the `if err == nil` block. Be careful with the `defer` — it's fine since it's scoped correctly. Alternatively, close explicitly after the loop.

  **Mock update (repositories.go):**

  The mock `DDLData` map already stores `*domain.DatasetDDL` values. Since we added `TableDDL` to the struct, the mock automatically supports it — no changes needed to mock methods. The mock just needs the struct field, which it gets from the domain import.

  </action>
  <verify>
  Run Go tests to confirm no regressions:
  ```bash
  cd lineage-api && go test ./internal/adapter/inbound/http/... -run TestGetDataset -v
  ```
  All 11 handler tests should pass. Verify the new `TableDDL` field compiles correctly:
  ```bash
  cd lineage-api && go build ./...
  ```
  </verify>
  <done>
  - Python statistics endpoint uses `MAX(RowCount)` without IndexNumber filter
  - Go statistics endpoint uses `MAX(RowCount)` without IndexNumber filter
  - DatasetDDL struct has TableDDL field with json tag "tableDdl,omitempty"
  - Python DDL endpoint runs SHOW TABLE for tables and returns tableDdl in response
  - Go DDL endpoint runs SHOW TABLE for tables and populates ddl.TableDDL
  - All existing Go handler tests pass
  - Go project compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update frontend to display table DDL with syntax highlighting</name>
  <files>
    lineage-ui/src/types/openlineage.ts
    lineage-ui/src/components/domain/LineageGraph/DetailPanel/DDLTab.tsx
    lineage-ui/src/components/domain/LineageGraph/DetailPanel.test.tsx
  </files>
  <action>
  **TypeScript type (openlineage.ts line ~150):**

  Add `tableDdl` field to `DatasetDDLResponse`:
  ```typescript
  export interface DatasetDDLResponse {
    datasetId: string;
    databaseName: string;
    tableName: string;
    sourceType: string;
    viewSql?: string;
    tableDdl?: string;         // NEW: CREATE TABLE DDL for tables
    truncated: boolean;
    tableComment?: string;
    columnComments?: Record<string, string>;
  }
  ```

  **DDLTab component (DDLTab.tsx lines 116-122):**

  Replace the else branch that shows "DDL is not available for tables" with a block that renders tableDdl when available. The component should handle three cases:
  1. View with viewSql — show view definition (existing, no change)
  2. Table with tableDdl — show CREATE TABLE DDL with syntax highlighting (NEW)
  3. No DDL available — show informational message (fallback)

  Replace the conditional block (lines 66-122) with:
  ```tsx
  {data.sourceType === 'VIEW' && data.viewSql ? (
    <div>
      <div className="flex items-center justify-between mb-2">
        <h4 className="text-sm font-medium text-slate-600">View Definition</h4>
        <button
          onClick={() => handleCopy(data.viewSql!)}
          className="flex items-center gap-1 px-2 py-1 text-xs bg-slate-700 text-slate-300 rounded hover:bg-slate-600"
          aria-label="Copy SQL"
        >
          {copied ? (
            <>
              <Check className="w-3 h-3" />
              Copied
            </>
          ) : (
            <>
              <Copy className="w-3 h-3" />
              Copy SQL
            </>
          )}
        </button>
      </div>

      {data.truncated && (
        <div className="mb-2 px-3 py-2 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-800">
          SQL truncated at 12,500 characters. Full definition may be longer.
        </div>
      )}

      <Highlight theme={themes.vsDark} code={data.viewSql} language="sql">
        {({ style, tokens, getLineProps, getTokenProps }) => (
          <pre
            className="rounded-lg text-sm font-mono overflow-auto max-h-96 p-3"
            style={style}
          >
            {tokens.map((line, i) => (
              <div key={i} {...getLineProps({ line })}>
                <span className="inline-block w-8 text-right mr-3 text-slate-500 select-none text-xs">
                  {i + 1}
                </span>
                {line.map((token, key) => (
                  <span key={key} {...getTokenProps({ token })} />
                ))}
              </div>
            ))}
          </pre>
        )}
      </Highlight>
    </div>
  ) : data.sourceType === 'TABLE' && data.tableDdl ? (
    <div>
      <div className="flex items-center justify-between mb-2">
        <h4 className="text-sm font-medium text-slate-600">Table Definition</h4>
        <button
          onClick={() => handleCopy(data.tableDdl!)}
          className="flex items-center gap-1 px-2 py-1 text-xs bg-slate-700 text-slate-300 rounded hover:bg-slate-600"
          aria-label="Copy DDL"
        >
          {copied ? (
            <>
              <Check className="w-3 h-3" />
              Copied
            </>
          ) : (
            <>
              <Copy className="w-3 h-3" />
              Copy DDL
            </>
          )}
        </button>
      </div>

      <Highlight theme={themes.vsDark} code={data.tableDdl} language="sql">
        {({ style, tokens, getLineProps, getTokenProps }) => (
          <pre
            className="rounded-lg text-sm font-mono overflow-auto max-h-96 p-3"
            style={style}
          >
            {tokens.map((line, i) => (
              <div key={i} {...getLineProps({ line })}>
                <span className="inline-block w-8 text-right mr-3 text-slate-500 select-none text-xs">
                  {i + 1}
                </span>
                {line.map((token, key) => (
                  <span key={key} {...getTokenProps({ token })} />
                ))}
              </div>
            ))}
          </pre>
        )}
      </Highlight>
    </div>
  ) : (
    <div className="p-4 bg-slate-50 border border-slate-200 rounded-lg">
      <p className="text-sm text-slate-600">
        No DDL available for this dataset.
      </p>
    </div>
  )}
  ```

  The key changes:
  - View case: unchanged (sourceType === 'VIEW' && viewSql)
  - Table case: NEW (sourceType === 'TABLE' && tableDdl) — renders with same Highlight component, heading says "Table Definition", copy button says "Copy DDL"
  - Fallback: changed from "DDL is not available for tables" to generic "No DDL available for this dataset" (covers edge case where SHOW TABLE fails)

  **Tests (DetailPanel.test.tsx):**

  Update the test at line ~681 ("shows message for table type (no DDL available)") to verify the new fallback message:
  - Change `expect(screen.getByText(/DDL is not available for tables/i))` to `expect(screen.getByText(/No DDL available/i))`

  Add a new test for table DDL rendering:
  ```typescript
  it('shows table DDL with syntax highlighting for table type', () => {
    mockUseDatasetDDL.mockReturnValue({
      data: {
        datasetId: 'test-id',
        databaseName: 'demo_user',
        tableName: 'SRC_CUSTOMERS',
        sourceType: 'TABLE',
        tableDdl: 'CREATE TABLE demo_user.SRC_CUSTOMERS (id INTEGER, name VARCHAR(100))',
        truncated: false,
        columnComments: {},
      },
      isLoading: false,
      error: null,
      refetch: vi.fn(),
    } as any);

    renderPanel({ type: 'column' });
    fireEvent.click(screen.getByRole('tab', { name: /ddl/i }));

    expect(screen.getByText('Table Definition')).toBeInTheDocument();
    expect(screen.getByLabelText('Copy DDL')).toBeInTheDocument();
  });
  ```

  Place this test inside the 'TC-PANEL-03: DDL tab content' describe block, after the existing table message test.

  </action>
  <verify>
  Run frontend unit tests:
  ```bash
  cd lineage-ui && npm test -- --run
  ```
  All DetailPanel tests should pass, including the updated table DDL test.
  </verify>
  <done>
  - DatasetDDLResponse type includes optional tableDdl field
  - DDLTab renders table DDL with Highlight component and "Table Definition" heading
  - DDLTab renders "Copy DDL" button for tables
  - DDLTab shows "No DDL available" as fallback (not "DDL is not available for tables")
  - View DDL rendering is unchanged (no regression)
  - Existing DetailPanel tests pass
  - New test verifies table DDL rendering with syntax highlighting
  </done>
</task>

</tasks>

<verification>
1. Go backend compiles: `cd lineage-api && go build ./...`
2. Go handler tests pass: `cd lineage-api && go test ./internal/adapter/inbound/http/... -run TestGetDataset -v` (11 tests)
3. Frontend tests pass: `cd lineage-ui && npm test -- --run` (all DetailPanel tests)
4. DatasetDDL struct has TableDDL field: `grep "TableDDL" lineage-api/internal/domain/entities.go`
5. Python uses MAX(RowCount): `grep -A2 "MAX(RowCount)" lineage-api/python_server.py`
6. Python runs SHOW TABLE: `grep "SHOW TABLE" lineage-api/python_server.py`
7. Go uses MAX(RowCount): `grep -A2 "MAX(RowCount)" lineage-api/internal/adapter/outbound/teradata/openlineage_repo.go`
8. Go runs SHOW TABLE: `grep "SHOW TABLE" lineage-api/internal/adapter/outbound/teradata/openlineage_repo.go`
9. Frontend type has tableDdl: `grep "tableDdl" lineage-ui/src/types/openlineage.ts`
10. DDLTab renders tableDdl: `grep "tableDdl" lineage-ui/src/components/domain/LineageGraph/DetailPanel/DDLTab.tsx`
</verification>

<success_criteria>
- Statistics tab displays row count values (not N/A) when table statistics exist in DBC.TableStatsV
- DDL tab displays CREATE TABLE DDL for tables with SQL syntax highlighting
- DDL tab continues to display view SQL for views (no regression)
- Copy button works for both view SQL and table DDL
- All Go handler tests pass (11/11)
- All frontend DetailPanel tests pass
- Graceful fallback: row count shows N/A only when genuinely unavailable, DDL shows "No DDL available" only when SHOW TABLE fails
</success_criteria>

<output>
After completion, create `.planning/phases/20-backend-statistics-&-ddl-api/20-04-SUMMARY.md`
</output>
