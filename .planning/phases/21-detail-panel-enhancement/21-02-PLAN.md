---
phase: 21-detail-panel-enhancement
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - lineage-ui/src/components/domain/LineageGraph/DetailPanel.tsx
  - lineage-ui/src/components/domain/LineageGraph/DetailPanel/TabBar.tsx
  - lineage-ui/src/components/domain/LineageGraph/DetailPanel/ColumnsTab.tsx
  - lineage-ui/src/components/domain/LineageGraph/DetailPanel/StatisticsTab.tsx
  - lineage-ui/src/components/domain/LineageGraph/DetailPanel/DDLTab.tsx
  - lineage-ui/src/components/domain/LineageGraph/LineageGraph.tsx
  - lineage-ui/src/components/domain/LineageGraph/DatabaseLineageGraph.tsx
  - lineage-ui/src/components/domain/LineageGraph/AllDatabasesLineageGraph.tsx

autonomous: true

must_haves:
  truths:
    - "User can switch between Columns, Statistics, and DDL tabs"
    - "Statistics tab displays table metadata (row count, size, dates, owner, type)"
    - "DDL tab shows view SQL with syntax highlighting"
    - "DDL tab shows column comments if available"
    - "Clicking a column name navigates to that column's lineage graph"
    - "Each tab shows loading state independently while fetching data"
    - "Failed fetches show graceful error state (not crash or blank)"
    - "Large content (many columns, long SQL) scrolls independently per tab"
  artifacts:
    - path: "lineage-ui/src/components/domain/LineageGraph/DetailPanel/TabBar.tsx"
      provides: "Accessible tab bar with ARIA roles and keyboard navigation"
      contains: "role=\"tablist\""
    - path: "lineage-ui/src/components/domain/LineageGraph/DetailPanel/ColumnsTab.tsx"
      provides: "Column list with click-to-navigate"
      contains: "navigate"
    - path: "lineage-ui/src/components/domain/LineageGraph/DetailPanel/StatisticsTab.tsx"
      provides: "Statistics display with loading/error states"
      contains: "useDatasetStatistics"
    - path: "lineage-ui/src/components/domain/LineageGraph/DetailPanel/DDLTab.tsx"
      provides: "DDL viewer with SQL syntax highlighting"
      contains: "Highlight"
    - path: "lineage-ui/src/components/domain/LineageGraph/DetailPanel.tsx"
      provides: "Refactored tabbed panel integrating all sub-components"
      contains: "TabBar"
  key_links:
    - from: "lineage-ui/src/components/domain/LineageGraph/DetailPanel/StatisticsTab.tsx"
      to: "lineage-ui/src/api/hooks/useOpenLineage.ts"
      via: "useDatasetStatistics hook with enabled flag"
      pattern: "useDatasetStatistics.*enabled"
    - from: "lineage-ui/src/components/domain/LineageGraph/DetailPanel/DDLTab.tsx"
      to: "lineage-ui/src/api/hooks/useOpenLineage.ts"
      via: "useDatasetDDL hook with enabled flag"
      pattern: "useDatasetDDL.*enabled"
    - from: "lineage-ui/src/components/domain/LineageGraph/DetailPanel/ColumnsTab.tsx"
      to: "/lineage/:datasetId/:fieldName"
      via: "useNavigate from react-router-dom"
      pattern: "navigate.*lineage"
    - from: "lineage-ui/src/components/domain/LineageGraph/LineageGraph.tsx"
      to: "lineage-ui/src/components/domain/LineageGraph/DetailPanel.tsx"
      via: "datasetId prop passed to DetailPanel"
      pattern: "datasetId=\\{datasetId\\}"
---

<objective>
Refactor the existing DetailPanel into a tabbed metadata viewer with Columns, Statistics, and DDL tabs. Create accessible tab bar, column-click navigation, statistics display with loading/error states, DDL viewer with SQL syntax highlighting, and update all three graph components to pass datasetId to the panel.

Purpose: This is the core UI work for Phase 21. Users will be able to explore table metadata (statistics, DDL, comments) directly from the graph's detail panel without leaving the visualization. Column names become clickable navigation links to their lineage graphs.

Output: Refactored DetailPanel.tsx with 4 new sub-components (TabBar, ColumnsTab, StatisticsTab, DDLTab), all wired to the API hooks from Plan 01.
</objective>

<execution_context>
@/Users/Daniel.Tehan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Daniel.Tehan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-detail-panel-enhancement/21-RESEARCH.md

# Existing files to refactor/extend
@lineage-ui/src/components/domain/LineageGraph/DetailPanel.tsx
@lineage-ui/src/components/domain/LineageGraph/LineageGraph.tsx
@lineage-ui/src/components/domain/LineageGraph/DatabaseLineageGraph.tsx
@lineage-ui/src/components/domain/LineageGraph/AllDatabasesLineageGraph.tsx

# API layer from Plan 01
@lineage-ui/src/types/openlineage.ts
@lineage-ui/src/api/hooks/useOpenLineage.ts

# Existing common components to reuse
@lineage-ui/src/components/common/LoadingSpinner.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sub-components (TabBar, ColumnsTab, StatisticsTab, DDLTab)</name>
  <files>
    lineage-ui/src/components/domain/LineageGraph/DetailPanel/TabBar.tsx
    lineage-ui/src/components/domain/LineageGraph/DetailPanel/ColumnsTab.tsx
    lineage-ui/src/components/domain/LineageGraph/DetailPanel/StatisticsTab.tsx
    lineage-ui/src/components/domain/LineageGraph/DetailPanel/DDLTab.tsx
  </files>
  <action>
Create the `DetailPanel/` directory inside `lineage-ui/src/components/domain/LineageGraph/` and create four sub-components:

**1. TabBar.tsx** - Accessible tab bar following W3C WAI-ARIA Tabs Pattern:
- Props: `tabs: { id: string; label: string; icon?: React.ReactNode }[]`, `activeTab: string`, `onTabChange: (id: string) => void`
- Use `role="tablist"` on container, `role="tab"` on each button, `aria-selected`, `aria-controls`, `tabIndex` roving
- Keyboard navigation: ArrowLeft/ArrowRight cycle through tabs, focus follows selection
- Styling: Tailwind `border-b border-slate-200`, active tab gets `border-blue-500 text-blue-600`, inactive gets `border-transparent text-slate-500 hover:text-slate-700`
- Also export a `TabPanel` component: wraps children in `div` with `role="tabpanel"`, `aria-labelledby`, `hidden` when not active, `overflow-y-auto flex-1` for independent scrolling (PANEL-08)
- TabPanel renders children only when `activeTab === id` (lazy rendering)

**2. ColumnsTab.tsx** - Column list with click-to-navigate:
- Props: `columns: ColumnDetail[]`, `datasetId: string` (needed for navigation URL)
- Import `ColumnDetail` from `../DetailPanel` (the parent module)
- Use `useNavigate` from `react-router-dom`
- Each column renders as a button with `onClick={() => navigate(\`/lineage/${encodeURIComponent(datasetId)}/${encodeURIComponent(col.columnName)}\`)` (PANEL-05)
- Display: column name (blue, clickable), data type badge (slate), nullable indicator (yellow "NULL" badge if true), primary key indicator (green "PK" badge if true)
- Show description below name if present
- Show lineage stats: "{upstream} upstream, {downstream} downstream" in muted text
- `overflow-y-auto` on container for scrollable list (PANEL-08)
- Empty state: "No columns available" text

**3. StatisticsTab.tsx** - Statistics display with loading/error:
- Props: `datasetId: string`, `isActive: boolean`
- Call `useDatasetStatistics(datasetId, { enabled: isActive })` (PANEL-06 - lazy loading)
- Loading state: render `LoadingSpinner` from `components/common/LoadingSpinner` with `size="sm"` and text "Loading statistics..."
- Error state: render a slate-colored box with error icon and "Failed to load statistics" text plus a "Retry" button calling `refetch()` (PANEL-07)
- Data display as a definition list (`dl`) with rows for:
  - Type: sourceType ("TABLE" or "VIEW")
  - Owner: creatorName (show "N/A" if missing)
  - Created: createTimestamp (format as locale date string, show "N/A" if missing)
  - Last Modified: lastAlterTimestamp (format as locale date string, show "N/A" if missing)
  - Row Count: rowCount (format with `Intl.NumberFormat().format()`, show "N/A" if null)
  - Size: sizeBytes (format with utility function: B/KB/MB/GB, SKIP this row entirely if null -- views have no size)
  - Comment: tableComment (show only if non-empty, render in italic)
- Define `formatBytes` and `formatNumber` as local utility functions within the file (or at the top). `formatBytes(null)` returns "N/A", `formatBytes(0)` returns "0 B", otherwise converts using 1024 units.

**4. DDLTab.tsx** - DDL/SQL viewer with syntax highlighting:
- Props: `datasetId: string`, `isActive: boolean`
- Call `useDatasetDDL(datasetId, { enabled: isActive })` (PANEL-06 - lazy loading)
- Loading state: render `LoadingSpinner` with text "Loading DDL..."
- Error state: same pattern as StatisticsTab (error box + Retry button) (PANEL-07)
- For VIEWS (data.sourceType === "VIEW" and data.viewSql is non-empty):
  - Show SQL with syntax highlighting using `Highlight` from `prism-react-renderer`
  - Import and register SQL language: `import { Highlight, themes, Prism } from 'prism-react-renderer'` then `(typeof globalThis !== 'undefined' ? globalThis : window).Prism = Prism` and dynamic `import('prismjs/components/prism-sql')` (wrap in useEffect with a `ready` state if async import needed; alternatively try synchronous approach first)
  - Use `themes.vsDark` for dark background (matches existing SqlViewer in the parent component)
  - Add line numbers (span with line index)
  - If `data.truncated` is true, show a yellow warning banner: "SQL truncated at 12,500 characters. Full definition may be longer."
  - Add a "Copy SQL" button (reuse the pattern from existing `SqlViewer` in DetailPanel.tsx: `navigator.clipboard.writeText(sql)`)
- For TABLES (data.sourceType === "TABLE" or no viewSql):
  - Show message: "DDL is not available for tables. Table definitions are managed by CREATE TABLE statements."
- Column comments section (PANEL-04): If `data.columnComments` is non-empty, show a "Column Comments" heading followed by a list of `columnName: comment` entries. Each entry shows the column name in mono font and the comment in regular text.
- Table comment: If `data.tableComment` is non-empty, show it above the SQL/message.
- `overflow-y-auto` on container (PANEL-08)

Important implementation notes:
- Use `lucide-react` icons: `Table2` or `LayoutList` for Columns tab, `BarChart3` for Statistics tab, `Code` for DDL tab
- All sub-components use Tailwind exclusively for styling (no inline styles except Prism theme `style` prop)
- Handle the case where SQL language registration via dynamic import is async -- use a `useEffect` + `useState(false)` pattern to track `sqlReady` state, only render `Highlight` when ready, fall back to plain `pre` while loading
  </action>
  <verify>
    - `cd lineage-ui && npx tsc --noEmit` passes (no type errors)
    - All four files exist: `ls lineage-ui/src/components/domain/LineageGraph/DetailPanel/`
    - Each file exports its component: `grep -l "export" lineage-ui/src/components/domain/LineageGraph/DetailPanel/*.tsx`
  </verify>
  <done>
    - TabBar renders accessible tabs with ARIA roles and keyboard navigation
    - ColumnsTab renders column list with clickable names that navigate to `/lineage/:datasetId/:fieldName`
    - StatisticsTab fetches from useDatasetStatistics only when active, shows loading/error/data states
    - DDLTab fetches from useDatasetDDL only when active, renders SQL with prism-react-renderer syntax highlighting
    - All sub-components handle null/empty data gracefully
    - TypeScript compiles cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor DetailPanel and update graph consumers</name>
  <files>
    lineage-ui/src/components/domain/LineageGraph/DetailPanel.tsx
    lineage-ui/src/components/domain/LineageGraph/LineageGraph.tsx
    lineage-ui/src/components/domain/LineageGraph/DatabaseLineageGraph.tsx
    lineage-ui/src/components/domain/LineageGraph/AllDatabasesLineageGraph.tsx
  </files>
  <action>
**1. Refactor DetailPanel.tsx:**

Restructure the component to use tabbed layout for column/node selections while keeping edge details as-is.

Changes to `DetailPanelProps` interface -- add a new optional prop:
```typescript
export interface DetailPanelProps {
  isOpen: boolean;
  onClose: () => void;
  selectedColumn?: ColumnDetail | null;
  selectedEdge?: EdgeDetail | null;
  datasetId?: string;                    // NEW: for statistics/DDL API calls
  onViewFullLineage?: (columnId: string) => void;
  onViewImpactAnalysis?: (columnId: string) => void;
}
```

Keep `ColumnDetail`, `EdgeDetail`, `ConfidenceBar`, and `SqlViewer` (the existing edge SQL viewer) as-is. They're still used for edge details.

Replace `renderColumnDetails()` with the tabbed layout:
- Add `useState<'columns' | 'statistics' | 'ddl'>('columns')` for active tab state
- Add `useEffect` that resets `activeTab` to `'columns'` when `selectedColumn?.id` changes (prevent stale tab data for new selection -- Pitfall 3 from research)
- When `selectedColumn` is present (not edge), render:
  1. Entity header: `{databaseName}.{tableName}` as the title (move from inside renderColumnDetails to the panel header area, replacing the generic "Column Details" text)
  2. `TabBar` with three tabs: Columns (LayoutList icon), Statistics (BarChart3 icon), DDL (Code icon)
  3. Three `TabPanel` wrappers:
     - `columns` tab: `ColumnsTab` component. For the `columns` prop, the tab needs ALL columns of the table, not just the selected one. Since `ColumnDetail` only has info about the selected column, pass `[selectedColumn]` as the column list for now -- the existing behavior shows the selected column's metadata. NOTE: The existing column metadata display (Data Type, Nullable, Primary Key, Description, Lineage Stats) should be preserved in the ColumnsTab. The "View Full Lineage" and "Impact Analysis" buttons should remain at the bottom of the columns tab.
     - `statistics` tab: `StatisticsTab` with `datasetId` (use the new `datasetId` prop) and `isActive={activeTab === 'statistics'}`
     - `ddl` tab: `DDLTab` with `datasetId` and `isActive={activeTab === 'ddl'}`
- Edge selection: When `selectedEdge` is present (not column), render the existing `renderEdgeDetails()` as-is (no tabs for edges)
- The panel container structure becomes: fixed-height flex-column with sticky header, TabBar (sticky below header when column selected), then flex-1 TabPanel area that scrolls independently

Important structural detail: The outer panel div should change from `overflow-y-auto` to `flex flex-col` (each tab panel handles its own scroll). The sticky header stays. The content area below header becomes `flex-1 overflow-hidden` with each TabPanel getting `overflow-y-auto` via the TabPanel component.

The `datasetId` prop needs to be derived correctly. In the three graph components, `datasetId` is already available as a prop/variable. Pass it through to DetailPanel.

If `datasetId` prop is not provided (backwards compatibility for DatabaseLineageGraph and AllDatabasesLineageGraph which may not have a single datasetId), construct it from `selectedColumn.databaseName` + `selectedColumn.tableName`. The format needed for the API is just `database.table` (without namespace prefix) -- the API accepts this format. Actually, check the actual API URL format: the endpoints use `{datasetId}` which is the OL_DATASET.id format. This is typically `namespace/database.table`. We need to check what format the graph nodes use.

Looking at the LineageGraph code, `datasetId` prop is the one from the URL route `/lineage/:datasetId/:fieldName`. This is the full dataset ID including namespace. For DatabaseLineageGraph and AllDatabasesLineageGraph, the datasetId is not directly available. For those, derive it from the selected node's data: the node's `id` format for column nodes is typically `namespace/database.table.column`. Strip the column name part to get the dataset ID.

Simpler approach: Add `datasetId` as an optional prop. In LineageGraph.tsx, pass the `datasetId` prop directly (it's available). In DatabaseLineageGraph.tsx and AllDatabasesLineageGraph.tsx, don't pass it -- the DetailPanel will fall back to a computed value from `selectedColumn`. Inside DetailPanel, compute the effective datasetId:
```typescript
const effectiveDatasetId = datasetId || (selectedColumn
  ? selectedColumn.id.substring(0, selectedColumn.id.lastIndexOf('.'))
  : '');
```
This strips the column name from the full column ID (`namespace/db.table.column` -> `namespace/db.table`).

**2. Update LineageGraph.tsx:**
Add `datasetId={datasetId}` prop to the `<DetailPanel>` invocation (around line 584-591). The `datasetId` variable is already in scope from `LineageGraphInnerProps`.

**3. Update DatabaseLineageGraph.tsx:**
Add `datasetId={undefined}` (or simply omit it) to the `<DetailPanel>` invocation. The component doesn't have a single datasetId. DetailPanel will fall back to computing it from the selected column's ID.

**4. Update AllDatabasesLineageGraph.tsx:**
Same as DatabaseLineageGraph -- omit `datasetId` prop. DetailPanel falls back to computed value.
  </action>
  <verify>
    - `cd lineage-ui && npx tsc --noEmit` passes (no type errors)
    - `cd lineage-ui && npm run build` succeeds (no build errors)
    - Verify tabbed structure: `grep -n "TabBar\|TabPanel\|activeTab" lineage-ui/src/components/domain/LineageGraph/DetailPanel.tsx`
    - Verify datasetId prop: `grep -n "datasetId" lineage-ui/src/components/domain/LineageGraph/LineageGraph.tsx | grep DetailPanel`
  </verify>
  <done>
    - DetailPanel shows three tabs (Columns, Statistics, DDL) when a column is selected
    - Edge selection still shows flat detail view (no tabs)
    - Tab state resets to "columns" when selection changes
    - Statistics tab lazy-fetches only when clicked
    - DDL tab lazy-fetches only when clicked
    - SQL syntax highlighting renders for views
    - Column names are clickable and navigate to lineage page
    - Each tab scrolls independently
    - Loading and error states display correctly per tab
    - LineageGraph passes datasetId to DetailPanel
    - Production build succeeds
  </done>
</task>

</tasks>

<verification>
1. `cd lineage-ui && npx tsc --noEmit` -- TypeScript compiles
2. `cd lineage-ui && npm run build` -- production build succeeds
3. Grep for ARIA roles: `grep -rn 'role="tablist"\|role="tab"\|role="tabpanel"' lineage-ui/src/components/domain/LineageGraph/DetailPanel/`
4. Grep for lazy fetching: `grep -n "enabled.*isActive" lineage-ui/src/components/domain/LineageGraph/DetailPanel/StatisticsTab.tsx lineage-ui/src/components/domain/LineageGraph/DetailPanel/DDLTab.tsx`
5. Grep for navigation: `grep -n "navigate.*lineage" lineage-ui/src/components/domain/LineageGraph/DetailPanel/ColumnsTab.tsx`
6. Grep for syntax highlighting: `grep -n "Highlight\|prism-react-renderer" lineage-ui/src/components/domain/LineageGraph/DetailPanel/DDLTab.tsx`
7. Grep for datasetId prop: `grep -n "datasetId" lineage-ui/src/components/domain/LineageGraph/DetailPanel.tsx | head -5`
</verification>

<success_criteria>
- 4 new sub-components created in DetailPanel/ directory
- DetailPanel.tsx refactored with tabbed layout for column selections
- Edge details unchanged (flat layout, no tabs)
- All 3 graph consumers updated (LineageGraph passes datasetId, others use fallback)
- Tabs are accessible (ARIA roles, keyboard navigation)
- Statistics and DDL tabs lazy-load data only when active
- SQL syntax highlighting works with prism-react-renderer
- Column names navigate to lineage page on click
- Loading spinners and error states render correctly
- Independent scrolling per tab
- TypeScript compiles and production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/21-detail-panel-enhancement/21-02-SUMMARY.md`
</output>
