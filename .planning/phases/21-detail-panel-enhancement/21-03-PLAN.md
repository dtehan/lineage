---
phase: 21-detail-panel-enhancement
plan: 03
type: execute
wave: 3
depends_on: ["21-02"]
files_modified:
  - lineage-ui/src/components/domain/LineageGraph/DetailPanel.test.tsx

autonomous: true

must_haves:
  truths:
    - "Existing panel visibility tests still pass with tabbed layout"
    - "Tab switching renders correct content"
    - "Column click triggers navigation"
    - "Loading and error states render in Statistics and DDL tabs"
    - "Edge details display unchanged"
  artifacts:
    - path: "lineage-ui/src/components/domain/LineageGraph/DetailPanel.test.tsx"
      provides: "Updated tests for tabbed DetailPanel plus new tests for tabs, loading, error, navigation"
      contains: "tab"
  key_links:
    - from: "lineage-ui/src/components/domain/LineageGraph/DetailPanel.test.tsx"
      to: "lineage-ui/src/components/domain/LineageGraph/DetailPanel.tsx"
      via: "render and screen queries"
      pattern: "render.*DetailPanel"
---

<objective>
Update existing DetailPanel tests and add comprehensive new tests for tab switching, loading states, error states, column click navigation, and edge details preservation.

Purpose: The DetailPanel was significantly refactored in Plan 02 (tabbed layout, sub-components, API integration). The 16 existing tests need updating to work with the new structure, and new tests are needed for all PANEL-01 through PANEL-08 requirements.

Output: Updated and extended DetailPanel.test.tsx with tests covering tabs, lazy loading, error handling, column navigation, and accessibility.
</objective>

<execution_context>
@/Users/Daniel.Tehan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Daniel.Tehan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-detail-panel-enhancement/21-RESEARCH.md

# Component under test (refactored in Plan 02)
@lineage-ui/src/components/domain/LineageGraph/DetailPanel.tsx
@lineage-ui/src/components/domain/LineageGraph/DetailPanel/TabBar.tsx
@lineage-ui/src/components/domain/LineageGraph/DetailPanel/ColumnsTab.tsx
@lineage-ui/src/components/domain/LineageGraph/DetailPanel/StatisticsTab.tsx
@lineage-ui/src/components/domain/LineageGraph/DetailPanel/DDLTab.tsx

# Existing tests to update
@lineage-ui/src/components/domain/LineageGraph/DetailPanel.test.tsx

# Test patterns
@lineage-ui/vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update existing tests for tabbed layout</name>
  <files>
    lineage-ui/src/components/domain/LineageGraph/DetailPanel.test.tsx
  </files>
  <action>
The existing DetailPanel.test.tsx has 16 tests in 6 describe blocks (TC-COMP-016 through TC-COMP-021). Many of these will need adjustments because the column details are now rendered inside a "Columns" tab (which is the default active tab, so text should still be visible).

**Required test infrastructure:**

1. Mock `react-router-dom`'s `useNavigate`:
```typescript
const mockNavigate = vi.fn();
vi.mock('react-router-dom', () => ({
  useNavigate: () => mockNavigate,
}));
```

2. Mock the TanStack Query hooks used by StatisticsTab and DDLTab:
```typescript
vi.mock('../../../../api/hooks/useOpenLineage', () => ({
  useDatasetStatistics: vi.fn(() => ({
    data: undefined,
    isLoading: false,
    error: null,
    refetch: vi.fn(),
  })),
  useDatasetDDL: vi.fn(() => ({
    data: undefined,
    isLoading: false,
    error: null,
    refetch: vi.fn(),
  })),
}));
```
Adjust the import path based on where the test file is relative to the hooks. The test is at `DetailPanel.test.tsx` in the `LineageGraph/` directory, so the relative path to hooks is `../../../../api/hooks/useOpenLineage`.

3. Mock prism-react-renderer (DDLTab uses it):
```typescript
vi.mock('prism-react-renderer', () => ({
  Highlight: ({ children }: any) => children({ className: '', style: {}, tokens: [], getLineProps: () => ({}), getTokenProps: () => ({}) }),
  themes: { vsDark: {} },
  Prism: {},
}));
```

4. Wrap renders in `MemoryRouter` from react-router-dom (needed for useNavigate in ColumnsTab):
```typescript
import { MemoryRouter } from 'react-router-dom';
// Then wrap renders:
render(
  <MemoryRouter>
    <DetailPanel ... />
  </MemoryRouter>
);
```

Actually, since useNavigate is mocked, MemoryRouter may not be needed. Test both approaches and use whichever works. If the mock fully replaces useNavigate, no router wrapper is needed.

5. Also wrap in `QueryClientProvider` for TanStack Query if hooks are not fully mocked at the module level. Since we're mocking the hooks at the module level (not the QueryClient), the provider shouldn't be needed.

**Update existing tests:**

- TC-COMP-016 (Panel visibility): Should still pass as-is since the outer panel div structure is preserved. Verify `translate-x-0` / `translate-x-full` classes still work.

- TC-COMP-016b (Animation classes): Should still pass since transition classes are on the same outer div.

- TC-COMP-017 (Column details display):
  - "displays full qualified column name" -- The header now shows `databaseName.tableName` instead of the full qualified column name. The full name with column might now appear inside the Columns tab. Update the assertion to match the new header format OR check that the column name appears in the Columns tab content.
  - "displays column metadata" -- Data type and description should still be visible in the default "columns" tab.
  - "displays lineage statistics" -- Upstream/downstream counts should still be visible in the columns tab.

- TC-COMP-018 (Edge details display): Should still pass since edge rendering is unchanged (no tabs for edges).

- TC-COMP-019 (Panel interactions):
  - "calls onClose" -- Should still pass (close button is in the same position).
  - "calls onViewFullLineage" / "calls onViewImpactAnalysis" -- These buttons should still be in the columns tab. Verify they're accessible in the default tab view.

- TC-COMP-020 (Accessibility):
  - Dialog role test should still pass.
  - aria-label test might need updating if the label changed (check if it now says "Detail panel" or still "Column details").
  - aria-hidden tests should still pass.

- TC-COMP-021 (Empty state): Should still pass.

**Important:** Add `datasetId` prop to all renders that pass `selectedColumn`, since the refactored component uses it. Use a test datasetId like `"ns1/sales_db.customers"`.

For each test that fails, update the assertion to match the new DOM structure. Do NOT change test IDs or purpose -- only adjust selectors and assertions to account for the tabbed layout.

Run tests iteratively: `cd lineage-ui && npm test -- --run DetailPanel` to check progress.
  </action>
  <verify>
    - `cd lineage-ui && npm test -- --run DetailPanel 2>&1 | tail -30` -- all existing test names still present and passing
  </verify>
  <done>
    - All 16 original tests updated to work with tabbed layout
    - Tests properly mock react-router-dom, TanStack Query hooks, and prism-react-renderer
    - No test removals (all original test cases preserved)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add new tests for tabs, loading, errors, and navigation</name>
  <files>
    lineage-ui/src/components/domain/LineageGraph/DetailPanel.test.tsx
  </files>
  <action>
Add new describe blocks to the existing test file for the new functionality:

**TC-PANEL-01: Tab switching**
- Default tab is "Columns" when panel opens with selectedColumn
- Clicking "Statistics" tab shows statistics content (or loading state)
- Clicking "DDL" tab shows DDL content (or loading state)
- Clicking back to "Columns" shows columns content
- Tab has correct ARIA attributes: `role="tab"`, `aria-selected="true"` for active
- Tab panel has `role="tabpanel"` attribute
- No tabs shown when selectedEdge is provided (edge detail view)

**TC-PANEL-02: Statistics tab content**
- Override `useDatasetStatistics` mock to return data:
```typescript
const mockUseDatasetStatistics = vi.mocked(useDatasetStatistics);
mockUseDatasetStatistics.mockReturnValue({
  data: {
    datasetId: 'ns1/sales_db.customers',
    databaseName: 'sales_db',
    tableName: 'customers',
    sourceType: 'TABLE',
    creatorName: 'admin',
    createTimestamp: '2024-01-15T10:00:00Z',
    lastAlterTimestamp: '2024-06-01T14:30:00Z',
    rowCount: 1500000,
    sizeBytes: 52428800,
    tableComment: 'Main customer table',
  },
  isLoading: false,
  error: null,
  refetch: vi.fn(),
} as any);
```
- Switch to Statistics tab and verify: "TABLE" text, "admin" text, formatted row count ("1,500,000"), formatted size, comment text displayed

**TC-PANEL-03: DDL tab content**
- Override `useDatasetDDL` mock to return view SQL data:
```typescript
mockUseDatasetDDL.mockReturnValue({
  data: {
    datasetId: 'ns1/analytics_db.customer_summary',
    databaseName: 'analytics_db',
    tableName: 'customer_summary',
    sourceType: 'VIEW',
    viewSql: 'SELECT customer_id, name FROM customers WHERE active = 1',
    truncated: false,
    tableComment: 'Customer summary view',
    columnComments: { customer_id: 'Unique identifier' },
  },
  isLoading: false,
  error: null,
  refetch: vi.fn(),
} as any);
```
- Switch to DDL tab and verify: SQL text present, "Customer summary view" comment displayed, "Unique identifier" column comment displayed
- Test truncation warning: set `truncated: true` and verify warning text appears

**TC-PANEL-04: Loading states (PANEL-06)**
- Override `useDatasetStatistics` mock with `isLoading: true`
- Switch to Statistics tab, verify loading indicator present
- Override `useDatasetDDL` mock with `isLoading: true`
- Switch to DDL tab, verify loading indicator present
- Columns tab should NOT show loading (it uses local data, not API)

**TC-PANEL-05: Error states (PANEL-07)**
- Override `useDatasetStatistics` mock with `error: new Error('Network error')`
- Switch to Statistics tab, verify error message displayed (e.g., "Failed to load statistics")
- Verify Retry button is present
- Same pattern for DDL tab error state

**TC-PANEL-06: Column click navigation (PANEL-05)**
- Render with selectedColumn in the Columns tab
- Click on the column name
- Verify `mockNavigate` was called with the expected URL: `/lineage/${encodeURIComponent(datasetId)}/${encodeURIComponent(columnName)}`

**TC-PANEL-07: Tab state resets on selection change**
- Render with selectedColumn, switch to Statistics tab
- Re-render with a different selectedColumn (different id)
- Verify active tab has reset to "Columns" (not still on Statistics)
- Use `rerender()` from render result to change props

**TC-PANEL-08: Independent scroll (smoke test)**
- Verify each TabPanel has `overflow-y-auto` class when active (check the DOM element's className)

Add a `beforeEach` that resets all mocks: `vi.clearAllMocks()` and resets the hook mocks to their default return values.

Run: `cd lineage-ui && npm test -- --run DetailPanel`
  </action>
  <verify>
    - `cd lineage-ui && npm test -- --run DetailPanel 2>&1` -- all tests pass (old + new)
    - `cd lineage-ui && npm test -- --run 2>&1 | tail -5` -- full test suite passes with no regressions
  </verify>
  <done>
    - 7+ new test groups covering PANEL-01 through PANEL-08 requirements
    - Tab switching tests verify correct content rendering
    - Loading state tests verify spinner appears for Statistics and DDL tabs
    - Error state tests verify error message and Retry button
    - Column navigation test verifies navigate() called with correct URL
    - Tab reset test verifies state resets on selection change
    - All tests pass (existing + new)
    - Full test suite has no regressions
  </done>
</task>

</tasks>

<verification>
1. `cd lineage-ui && npm test -- --run DetailPanel 2>&1` -- all DetailPanel tests pass
2. `cd lineage-ui && npm test -- --run 2>&1 | tail -10` -- full test suite passes
3. Count tests: `cd lineage-ui && npm test -- --run DetailPanel 2>&1 | grep -c "PASS\|FAIL\|✓\|×"` -- should show ~25+ tests
4. Verify coverage of requirements: grep for test names matching PANEL-01 through PANEL-08
</verification>

<success_criteria>
- All 16 original tests pass (updated for tabbed layout)
- 7+ new test groups covering tab switching, statistics display, DDL display, loading states, error states, column navigation, tab reset, and scroll behavior
- Full test suite passes with zero regressions
- Tests properly mock external dependencies (react-router-dom, TanStack Query hooks, prism-react-renderer)
- Each PANEL requirement (01-08) has at least one test covering it
</success_criteria>

<output>
After completion, create `.planning/phases/21-detail-panel-enhancement/21-03-SUMMARY.md`
</output>
