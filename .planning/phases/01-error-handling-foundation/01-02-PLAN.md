---
phase: 01-error-handling-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - lineage-api/internal/adapter/inbound/http/handlers.go
  - lineage-api/cmd/server/main.go
autonomous: true

must_haves:
  truths:
    - "API returns generic error message when database query fails"
    - "Error responses contain request_id but no SQL, table names, or connection details"
    - "Server logs include full error details with request_id"
  artifacts:
    - path: "lineage-api/internal/adapter/inbound/http/handlers.go"
      provides: "Secure error handling in all handlers"
      contains: "Internal server error"
    - path: "lineage-api/cmd/server/main.go"
      provides: "Logger initialization at startup"
      contains: "logging.SetDefault"
  key_links:
    - from: "lineage-api/internal/adapter/inbound/http/handlers.go"
      to: "lineage-api/internal/infrastructure/logging/logger.go"
      via: "slog.ErrorContext logging"
      pattern: "slog\\.ErrorContext"
    - from: "lineage-api/internal/adapter/inbound/http/handlers.go"
      to: "lineage-api/internal/adapter/inbound/http/response.go"
      via: "respondError with request"
      pattern: "respondError\\(w, r,"
---

<objective>
Update all HTTP handlers to use secure error handling: log full error details server-side, return generic messages to clients.

Purpose: Prevent information leakage through API error responses while maintaining debuggability via structured logs with request IDs.

Output:
- Updated `handlers.go` with secure error handling pattern
- Updated `main.go` with logger initialization
</objective>

<execution_context>
@/Users/Daniel.Tehan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Daniel.Tehan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-error-handling-foundation/01-RESEARCH.md
@.planning/phases/01-error-handling-foundation/01-01-SUMMARY.md

# Source files to modify
@lineage-api/internal/adapter/inbound/http/handlers.go
@lineage-api/cmd/server/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update handlers with secure error handling</name>
  <files>lineage-api/internal/adapter/inbound/http/handlers.go</files>
  <action>
Update ALL error handling in `lineage-api/internal/adapter/inbound/http/handlers.go`:

1. Add import for `log/slog` and `github.com/go-chi/chi/v5/middleware`

2. For EVERY handler that calls `respondError`, update to use the two-layer pattern:

**Before (INSECURE):**
```go
if err != nil {
    respondError(w, http.StatusInternalServerError, err.Error())
    return
}
```

**After (SECURE):**
```go
if err != nil {
    requestID := middleware.GetReqID(r.Context())
    slog.ErrorContext(ctx, "failed to list databases",
        "request_id", requestID,
        "error", err,
        "method", r.Method,
        "path", r.URL.Path,
    )
    respondError(w, r, http.StatusInternalServerError, "Internal server error")
    return
}
```

3. Update each handler with appropriate log message describing the operation:
   - ListDatabases: "failed to list databases"
   - ListTables: "failed to list tables" + include database_name in log
   - ListColumns: "failed to list columns" + include database_name and table_name in log
   - GetLineage: "failed to get lineage" + include asset_id in log
   - GetUpstreamLineage: "failed to get upstream lineage" + include asset_id in log
   - GetDownstreamLineage: "failed to get downstream lineage" + include asset_id in log
   - GetImpactAnalysis: "failed to get impact analysis" + include asset_id in log
   - Search: "failed to search" + include query in log

4. Use STATIC generic messages for ALL error responses:
   - HTTP 500: "Internal server error"
   - NEVER use `err.Error()` in response message

Important patterns:
- Log BEFORE responding (so log has same request_id as response)
- Include request context: method, path, relevant parameters
- Keep error message to client GENERIC (no specifics)
  </action>
  <verify>
Run `go build ./...` from lineage-api directory - should compile.
Run `go vet ./...` - no issues.
Grep for `err.Error()` in handlers.go - should find ZERO occurrences in respondError calls.
  </verify>
  <done>
- All 8 handlers updated with secure error pattern
- Zero occurrences of `err.Error()` passed to respondError
- Each handler logs with appropriate operation name and parameters
- All error responses use "Internal server error" message
  </done>
</task>

<task type="auto">
  <name>Task 2: Initialize logger at application startup</name>
  <files>lineage-api/cmd/server/main.go</files>
  <action>
Update `lineage-api/cmd/server/main.go` to initialize the structured logger at startup:

1. Add import for the logging package:
```go
import "github.com/lineage-api/internal/infrastructure/logging"
```

2. At the START of main() (before any other operations), add:
```go
// Initialize structured JSON logging
logger := logging.NewLogger(slog.LevelInfo)
logging.SetDefault(logger)
```

3. Add import for `log/slog` for the slog.LevelInfo constant

4. Optionally, update existing log.Printf calls to use slog.Info where appropriate (not required, Chi middleware handles request logging)

This ensures all slog calls throughout the application use the JSON handler with source information.
  </action>
  <verify>
Run `go build ./...` from lineage-api directory - should compile.
Run `go run cmd/server/main.go` briefly (Ctrl+C to stop) - server starts without errors.
  </verify>
  <done>
- main.go imports logging package
- Logger initialized before server setup
- Application starts successfully
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. Application compiles: `go build ./...`
2. Application starts: `go run cmd/server/main.go` (then Ctrl+C)
3. No `err.Error()` in respondError calls: `grep -n "err.Error()" lineage-api/internal/adapter/inbound/http/handlers.go`
4. All handlers use slog: `grep -c "slog.ErrorContext" lineage-api/internal/adapter/inbound/http/handlers.go` returns 8 (one per handler)
</verification>

<success_criteria>
- [x] handlers.go compiles with new respondError signature
- [x] All 8 handlers log errors with slog.ErrorContext
- [x] All error responses use generic "Internal server error" message
- [x] main.go initializes logger at startup
- [x] Application starts and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-error-handling-foundation/01-02-SUMMARY.md`
</output>
