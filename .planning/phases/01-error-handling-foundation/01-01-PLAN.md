---
phase: 01-error-handling-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lineage-api/internal/infrastructure/logging/logger.go
  - lineage-api/internal/adapter/inbound/http/response.go
  - lineage-api/internal/adapter/inbound/http/handlers.go
autonomous: true

must_haves:
  truths:
    - "Error responses include request_id field for support correlation"
    - "Error response format is consistent JSON across all endpoints"
    - "API consumers see no internal details in error messages"
  artifacts:
    - path: "lineage-api/internal/infrastructure/logging/logger.go"
      provides: "slog JSON logger configuration with stack trace capture"
      exports: ["NewLogger", "SetDefault", "GetRequestLogger", "CaptureStack"]
      min_lines: 30
    - path: "lineage-api/internal/adapter/inbound/http/response.go"
      provides: "ErrorResponse struct with request_id"
      contains: "RequestID"
  key_links:
    - from: "lineage-api/internal/infrastructure/logging/logger.go"
      to: "log/slog"
      via: "slog.NewJSONHandler"
      pattern: "slog\\.NewJSONHandler"
    - from: "lineage-api/internal/adapter/inbound/http/response.go"
      to: "chi/middleware"
      via: "GetReqID context extraction"
      pattern: "middleware\\.GetReqID"
---

<objective>
Create the error handling infrastructure: structured logging with slog (including stack trace capture) and enhanced error response format with request ID.

Purpose: Establish the foundation for secure error handling. Structured logging enables server-side debugging while request IDs in responses allow error correlation without exposing internal details.

Output:
- `lineage-api/internal/infrastructure/logging/logger.go` - slog JSON logger with stack trace capture
- Updated `lineage-api/internal/adapter/inbound/http/response.go` - ErrorResponse with request_id
- Updated handler calls to use new respondError signature
</objective>

<execution_context>
@/Users/Daniel.Tehan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Daniel.Tehan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-error-handling-foundation/01-RESEARCH.md

# Source files to modify
@lineage-api/internal/adapter/inbound/http/response.go
@lineage-api/internal/adapter/inbound/http/handlers.go
@lineage-api/internal/adapter/inbound/http/router.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create structured logger with slog and stack trace capture</name>
  <files>lineage-api/internal/infrastructure/logging/logger.go</files>
  <action>
Create a new file `lineage-api/internal/infrastructure/logging/logger.go` that:

1. Creates package `logging` in the infrastructure layer
2. Implements `NewLogger(level slog.Level) *slog.Logger` that:
   - Uses `slog.NewJSONHandler` with `os.Stdout`
   - Sets `AddSource: true` in HandlerOptions to include file:line in logs
   - Returns configured logger
3. Implements `SetDefault(logger *slog.Logger)` that calls `slog.SetDefault()`
4. Includes helper function `GetRequestLogger(ctx context.Context) *slog.Logger` that:
   - Extracts request ID from context using `middleware.GetReqID(ctx)`
   - Returns logger with `request_id` attribute pre-attached via `slog.With()`
5. Implements `CaptureStack() string` function that:
   - Uses `runtime.Callers()` to capture the call stack
   - Uses `runtime.CallersFrames()` to format frame information
   - Returns formatted stack trace as string (one line per frame: "function @ file:line")
   - Skips the first 2-3 frames (CaptureStack itself and its caller)
   - Limits to max 10 frames to avoid excessive output

Use Go 1.21+ `log/slog` standard library (NOT external packages like zerolog/zap).
Import `github.com/go-chi/chi/v5/middleware` for GetReqID.
Import `runtime` for stack trace capture.

Example stack trace output format:
```
main.handleError @ /app/handlers.go:45
main.ListDatabases @ /app/handlers.go:23
net/http.HandlerFunc.ServeHTTP @ /usr/local/go/src/net/http/server.go:2136
```

Example log output format with stack:
```json
{"time":"2024-01-15T10:00:00Z","level":"ERROR","msg":"database query failed","request_id":"abc123","error":"connection refused","stack":"main.handleError @ handlers.go:45\nmain.ListDatabases @ handlers.go:23"}
```
  </action>
  <verify>
Run `go build ./...` from lineage-api directory - compilation succeeds.
Verify file exists at expected path.
Verify CaptureStack function exists: `grep -c "func CaptureStack" lineage-api/internal/infrastructure/logging/logger.go` returns 1
  </verify>
  <done>
- `logger.go` compiles without errors
- Exports NewLogger, SetDefault, GetRequestLogger, CaptureStack functions
- Uses slog.NewJSONHandler (not text handler)
- CaptureStack uses runtime.Callers for stack trace capture
  </done>
</task>

<task type="auto">
  <name>Task 2: Update error response format with request ID</name>
  <files>lineage-api/internal/adapter/inbound/http/response.go</files>
  <action>
Update `lineage-api/internal/adapter/inbound/http/response.go` to:

1. Add `ErrorResponse` struct:
```go
type ErrorResponse struct {
    Error     string `json:"error"`
    RequestID string `json:"request_id"`
}
```

2. Update `respondError` function signature to accept request context:
```go
func respondError(w http.ResponseWriter, r *http.Request, status int, message string)
```

3. Extract request ID from context using `middleware.GetReqID(r.Context())`

4. Return ErrorResponse with both error message and request_id

5. Add import for `github.com/go-chi/chi/v5/middleware`

Important: Do NOT add logging here - logging will be done in handlers (Plan 02).
Keep this function focused on response formatting only.
  </action>
  <verify>
Run `go build ./internal/adapter/inbound/http/response.go` from lineage-api directory - file itself compiles.
Verify ErrorResponse struct exists: `grep -c "type ErrorResponse struct" lineage-api/internal/adapter/inbound/http/response.go` returns 1
Note: Full build will fail until Task 3 updates handlers - this is expected.
  </verify>
  <done>
- `response.go` has ErrorResponse struct with Error and RequestID fields
- `respondError` function accepts `*http.Request` parameter
- Request ID extracted from context via middleware.GetReqID
  </done>
</task>

<task type="auto">
  <name>Task 3: Update handler calls to use new respondError signature</name>
  <files>lineage-api/internal/adapter/inbound/http/handlers.go</files>
  <action>
Update ALL calls to `respondError` in `lineage-api/internal/adapter/inbound/http/handlers.go` to pass the request parameter.

This is a mechanical refactor - DO NOT add logging yet (that's Plan 02). Just update the function calls.

**Before:**
```go
respondError(w, http.StatusBadRequest, "missing database name")
respondError(w, http.StatusInternalServerError, err.Error())
```

**After:**
```go
respondError(w, r, http.StatusBadRequest, "missing database name")
respondError(w, r, http.StatusInternalServerError, err.Error())
```

For now, keep the existing error messages (including `err.Error()` calls). Plan 02 will replace these with secure generic messages and add logging.

Find all occurrences with: `grep -n "respondError(w," handlers.go`
Update each one to include `r,` as the second argument.
  </action>
  <verify>
Run `go build ./...` from lineage-api directory - should compile successfully now.
Run `go vet ./...` - no issues.
Count updated calls: `grep -c "respondError(w, r," lineage-api/internal/adapter/inbound/http/handlers.go` returns number of handler error points.
  </verify>
  <done>
- All respondError calls updated to pass request parameter
- Code compiles without errors
- No functionality changed - just signature alignment
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `lineage-api/internal/infrastructure/logging/logger.go` exists and compiles
2. `lineage-api/internal/adapter/inbound/http/response.go` has ErrorResponse struct
3. Full application compiles: `go build ./...` succeeds
4. `go vet ./...` passes
</verification>

<success_criteria>
- [x] logger.go created with slog JSON configuration and CaptureStack function
- [x] response.go updated with ErrorResponse struct
- [x] handlers.go updated with new respondError signature
- [x] Both files use Go standard library (slog, runtime) and Chi middleware (GetReqID)
- [x] Full codebase compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/01-error-handling-foundation/01-01-SUMMARY.md`
</output>
