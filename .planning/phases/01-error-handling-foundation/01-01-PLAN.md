---
phase: 01-error-handling-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lineage-api/internal/infrastructure/logging/logger.go
  - lineage-api/internal/adapter/inbound/http/response.go
autonomous: true

must_haves:
  truths:
    - "Structured JSON logger is initialized at application startup"
    - "Error responses include request_id field"
    - "Error response format is consistent across all endpoints"
  artifacts:
    - path: "lineage-api/internal/infrastructure/logging/logger.go"
      provides: "slog JSON logger configuration"
      exports: ["NewLogger", "SetDefault"]
      min_lines: 20
    - path: "lineage-api/internal/adapter/inbound/http/response.go"
      provides: "ErrorResponse struct with request_id"
      contains: "RequestID"
  key_links:
    - from: "lineage-api/internal/infrastructure/logging/logger.go"
      to: "log/slog"
      via: "slog.NewJSONHandler"
      pattern: "slog\\.NewJSONHandler"
    - from: "lineage-api/internal/adapter/inbound/http/response.go"
      to: "chi/middleware"
      via: "GetReqID context extraction"
      pattern: "middleware\\.GetReqID"
---

<objective>
Create the error handling infrastructure: structured logging with slog and enhanced error response format with request ID.

Purpose: Establish the foundation for secure error handling. Structured logging enables server-side debugging while request IDs in responses allow error correlation without exposing internal details.

Output:
- `lineage-api/internal/infrastructure/logging/logger.go` - slog JSON logger
- Updated `lineage-api/internal/adapter/inbound/http/response.go` - ErrorResponse with request_id
</objective>

<execution_context>
@/Users/Daniel.Tehan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Daniel.Tehan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-error-handling-foundation/01-RESEARCH.md

# Source files to modify
@lineage-api/internal/adapter/inbound/http/response.go
@lineage-api/internal/adapter/inbound/http/router.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create structured logger with slog</name>
  <files>lineage-api/internal/infrastructure/logging/logger.go</files>
  <action>
Create a new file `lineage-api/internal/infrastructure/logging/logger.go` that:

1. Creates package `logging` in the infrastructure layer
2. Implements `NewLogger(level slog.Level) *slog.Logger` that:
   - Uses `slog.NewJSONHandler` with `os.Stdout`
   - Sets `AddSource: true` in HandlerOptions to include file:line in logs
   - Returns configured logger
3. Implements `SetDefault(logger *slog.Logger)` that calls `slog.SetDefault()`
4. Includes helper function `GetRequestLogger(ctx context.Context) *slog.Logger` that:
   - Extracts request ID from context using `middleware.GetReqID(ctx)`
   - Returns logger with `request_id` attribute pre-attached via `slog.With()`

Use Go 1.21+ `log/slog` standard library (NOT external packages like zerolog/zap).
Import `github.com/go-chi/chi/v5/middleware` for GetReqID.

Example log output format:
```json
{"time":"2024-01-15T10:00:00Z","level":"ERROR","msg":"database query failed","request_id":"abc123","error":"connection refused"}
```
  </action>
  <verify>
Run `go build ./...` from lineage-api directory - compilation succeeds.
Verify file exists at expected path.
  </verify>
  <done>
- `logger.go` compiles without errors
- Exports NewLogger, SetDefault, GetRequestLogger functions
- Uses slog.NewJSONHandler (not text handler)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update error response format with request ID</name>
  <files>lineage-api/internal/adapter/inbound/http/response.go</files>
  <action>
Update `lineage-api/internal/adapter/inbound/http/response.go` to:

1. Add `ErrorResponse` struct:
```go
type ErrorResponse struct {
    Error     string `json:"error"`
    RequestID string `json:"request_id"`
}
```

2. Update `respondError` function signature to accept request context:
```go
func respondError(w http.ResponseWriter, r *http.Request, status int, message string)
```

3. Extract request ID from context using `middleware.GetReqID(r.Context())`

4. Return ErrorResponse with both error message and request_id

5. Add import for `github.com/go-chi/chi/v5/middleware`

Important: Do NOT add logging here - logging will be done in handlers (Plan 02).
Keep this function focused on response formatting only.
  </action>
  <verify>
Run `go build ./...` from lineage-api directory - compilation will show errors in handlers.go because function signature changed. This is expected and will be fixed in Plan 02.
Verify ErrorResponse struct exists in file.
  </verify>
  <done>
- `response.go` has ErrorResponse struct with Error and RequestID fields
- `respondError` function accepts `*http.Request` parameter
- Request ID extracted from context via middleware.GetReqID
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `lineage-api/internal/infrastructure/logging/logger.go` exists and compiles
2. `lineage-api/internal/adapter/inbound/http/response.go` has ErrorResponse struct
3. Build errors in handlers.go are expected (fixed in Plan 02)
</verification>

<success_criteria>
- [x] logger.go created with slog JSON configuration
- [x] response.go updated with ErrorResponse struct
- [x] Both files use Go standard library (slog) and Chi middleware (GetReqID)
- [x] Files compile independently (handlers will break - that's OK)
</success_criteria>

<output>
After completion, create `.planning/phases/01-error-handling-foundation/01-01-SUMMARY.md`
</output>
