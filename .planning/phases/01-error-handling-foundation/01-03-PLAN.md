---
phase: 01-error-handling-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - lineage-api/internal/adapter/inbound/http/handlers_test.go
autonomous: true

must_haves:
  truths:
    - "Integration tests verify error responses contain no database schema information"
    - "Tests confirm request_id is present in error responses"
    - "Tests verify generic error message for all internal errors"
  artifacts:
    - path: "lineage-api/internal/adapter/inbound/http/handlers_test.go"
      provides: "Error response security tests"
      contains: "TestErrorResponseNoSensitiveData"
      min_lines: 50
  key_links:
    - from: "lineage-api/internal/adapter/inbound/http/handlers_test.go"
      to: "lineage-api/internal/adapter/inbound/http/handlers.go"
      via: "handler method invocation"
      pattern: "handler\\.(ListDatabases|GetLineage)"
---

<objective>
Create integration tests that verify error responses never expose sensitive database information and always include request IDs.

Purpose: Ensure security requirements SEC-03 and SEC-04 are verified by tests (TEST-02). Tests provide regression protection against future changes that might accidentally leak internal details.

Output:
- New or updated `lineage-api/internal/adapter/inbound/http/handlers_test.go` with security tests
</objective>

<execution_context>
@/Users/Daniel.Tehan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Daniel.Tehan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-error-handling-foundation/01-RESEARCH.md
@.planning/phases/01-error-handling-foundation/01-01-SUMMARY.md

# Test file location
@lineage-api/internal/adapter/inbound/http/handlers_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create error response security tests</name>
  <files>lineage-api/internal/adapter/inbound/http/handlers_test.go</files>
  <action>
Create or update `lineage-api/internal/adapter/inbound/http/handlers_test.go` with comprehensive tests for error response security.

1. Create mock implementations for the services that can return errors:
```go
type mockAssetService struct {
    ListDatabasesErr error
    ListTablesErr    error
    ListColumnsErr   error
}

type mockLineageService struct {
    GetLineageGraphErr      error
    GetUpstreamLineageErr   error
    GetDownstreamLineageErr error
    GetImpactAnalysisErr    error
}

type mockSearchService struct {
    SearchErr error
}
```

2. Implement test helper function `setupTestHandler()` that creates Handler with mock services

3. Create test `TestErrorResponseNoSensitiveData` that:
   - Injects a database error with sensitive details:
     ```go
     mockErr := errors.New(
         "teradatasql.Error: [SQLState HY000] [Version 17.20.0] " +
         "Failed to connect to 'test-host.env.clearscape.teradata.com:1025' " +
         "as user 'demo_user' password='****': Connection refused",
     )
     ```
   - Calls the handler
   - Asserts response status is 500
   - Parses response JSON
   - Asserts `error` field equals "Internal server error"
   - Asserts `request_id` field is present and non-empty
   - Asserts response body does NOT contain any of:
     - "teradatasql"
     - "SQLState"
     - "clearscape.teradata.com"
     - "demo_user"
     - "password"
     - "LIN_" (table prefix)
     - "SELECT" (SQL keyword)
     - "FROM" (SQL keyword)
     - "Connection refused" (internal error detail)

4. Create test `TestErrorResponseHasRequestID` that:
   - Triggers any error
   - Verifies response contains `request_id` field
   - Verifies `request_id` is non-empty string

5. Create test table `TestAllHandlersReturnGenericError` that:
   - Tests each handler (ListDatabases, ListTables, ListColumns, GetLineage, GetUpstreamLineage, GetDownstreamLineage, GetImpactAnalysis, Search)
   - For each: inject error, verify response is exactly `{"error":"Internal server error","request_id":"..."}` format

6. Add Chi context setup to tests:
```go
req = req.WithContext(context.WithValue(req.Context(), chi.RouteCtxKey, chi.NewRouteContext()))
// Also add request ID via chi middleware
ctx := context.WithValue(req.Context(), middleware.RequestIDKey, "test-request-id")
req = req.WithContext(ctx)
```

Use standard Go testing package with testify/assert for assertions.
  </action>
  <verify>
Run tests: `cd lineage-api && go test -v ./internal/adapter/inbound/http/...`
All tests pass.
Test count includes at least 3 new test functions.
  </verify>
  <done>
- handlers_test.go has TestErrorResponseNoSensitiveData
- handlers_test.go has TestErrorResponseHasRequestID
- handlers_test.go has TestAllHandlersReturnGenericError (or table-driven equivalent)
- All tests pass
- Tests verify no sensitive data leakage in error responses
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify test coverage for all handlers</name>
  <files>lineage-api/internal/adapter/inbound/http/handlers_test.go</files>
  <action>
Ensure test coverage is complete:

1. Verify each of the 8 error-handling code paths has test coverage:
   - ListDatabases error path
   - ListTables error path
   - ListColumns error path
   - GetLineage error path
   - GetUpstreamLineage error path
   - GetDownstreamLineage error path
   - GetImpactAnalysis error path
   - Search error path

2. If any paths are missing, add them to the table-driven test

3. Run coverage report to verify error handling paths are covered:
   ```bash
   go test -coverprofile=coverage.out ./internal/adapter/inbound/http/...
   go tool cover -func=coverage.out | grep handlers.go
   ```

4. Add any missing imports (errors, encoding/json, net/http/httptest, etc.)

Target: Each handler's error path should be executed at least once by tests.
  </action>
  <verify>
Run `go test -v ./internal/adapter/inbound/http/...` - all pass.
Run coverage: `go test -cover ./internal/adapter/inbound/http/...` - shows coverage percentage.
  </verify>
  <done>
- All 8 handlers have error path test coverage
- Tests pass without failures
- Coverage report shows error handling paths covered
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `go test -v ./internal/adapter/inbound/http/...` passes with all tests green
2. Error response tests verify no sensitive data leakage
3. Tests are table-driven for maintainability
4. Coverage includes all handler error paths
</verification>

<success_criteria>
- [x] TestErrorResponseNoSensitiveData exists and passes
- [x] TestErrorResponseHasRequestID exists and passes
- [x] All 8 handlers have error path coverage
- [x] No sensitive data (SQL, table names, connection strings) appears in any error response
- [x] Tests use testify/assert for clear assertions
</success_criteria>

<output>
After completion, create `.planning/phases/01-error-handling-foundation/01-03-SUMMARY.md`
</output>
