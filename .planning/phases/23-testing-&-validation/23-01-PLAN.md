---
phase: 23-testing-and-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lineage-ui/src/components/common/Tooltip.test.tsx
  - lineage-ui/src/components/domain/LineageGraph/TableNode/ColumnRow.test.tsx
  - lineage-ui/src/components/domain/LineageGraph/hooks/useFitToSelection.test.ts
autonomous: true

must_haves:
  truths:
    - "Tooltip shows correct content after hover delay for PK, FK, data type, and long column name triggers"
    - "Tooltip hides on mouse leave"
    - "Tooltip does not render when disabled or content is empty"
    - "ColumnRow renders PK/FK badges with tooltips that show on hover"
    - "useFitToSelection calls fitView with correct table node IDs, padding, and duration"
    - "useFitToSelection reports hasSelection=false when no highlighted nodes"
  artifacts:
    - path: "lineage-ui/src/components/common/Tooltip.test.tsx"
      provides: "Tooltip hover unit tests for TEST-01"
      min_lines: 80
    - path: "lineage-ui/src/components/domain/LineageGraph/TableNode/ColumnRow.test.tsx"
      provides: "ColumnRow tooltip tests for different node types (PK, FK, data type)"
      min_lines: 100
    - path: "lineage-ui/src/components/domain/LineageGraph/hooks/useFitToSelection.test.ts"
      provides: "Fit-to-selection viewport calculation tests for TEST-02"
      min_lines: 80
  key_links:
    - from: "Tooltip.test.tsx"
      to: "Tooltip.tsx"
      via: "render + fireEvent.mouseEnter/mouseLeave"
      pattern: "fireEvent\\.mouse(Enter|Leave)"
    - from: "ColumnRow.test.tsx"
      to: "ColumnRow.tsx"
      via: "render + fireEvent.mouseEnter on PK/FK/dataType elements"
      pattern: "fireEvent\\.mouseEnter"
    - from: "useFitToSelection.test.ts"
      to: "useFitToSelection.ts"
      via: "renderHook with mocked useReactFlow and useLineageStore"
      pattern: "renderHook.*useFitToSelection"
---

<objective>
Add comprehensive frontend unit and integration tests for hover tooltip behavior (TEST-01) and fit-to-selection viewport calculations (TEST-02).

Purpose: Cover the two untested frontend features from v4.0 -- Tooltip hover behavior across different node types (PK, FK, data type, long column names) and the useFitToSelection hook that maps highlighted column IDs to parent table nodes for viewport fitting.

Output: Three new test files with full coverage of tooltip interactions and viewport calculations.
</objective>

<execution_context>
@/Users/Daniel.Tehan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Daniel.Tehan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-testing-&-validation/23-RESEARCH.md

@lineage-ui/src/components/common/Tooltip.tsx
@lineage-ui/src/components/domain/LineageGraph/TableNode/ColumnRow.tsx
@lineage-ui/src/components/domain/LineageGraph/hooks/useFitToSelection.ts
@lineage-ui/src/components/domain/LineageGraph/hooks/useSmartViewport.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tooltip and ColumnRow hover tests (TEST-01)</name>
  <files>
    lineage-ui/src/components/common/Tooltip.test.tsx
    lineage-ui/src/components/domain/LineageGraph/TableNode/ColumnRow.test.tsx
  </files>
  <action>
Create `Tooltip.test.tsx` in `lineage-ui/src/components/common/` with these test cases:

**Tooltip.test.tsx (the Tooltip component itself):**
1. Shows tooltip after hover delay (200ms default) -- use vi.useFakeTimers(), fireEvent.mouseEnter, vi.advanceTimersByTime(200), check role="tooltip" appears
2. Does NOT show tooltip before delay elapses -- mouseEnter then check queryByRole('tooltip') is null immediately
3. Hides tooltip on mouseLeave -- show tooltip, then mouseLeave, check tooltip gone
4. Supports custom delay prop -- render with delay={500}, advance 200ms (still hidden), advance 300ms more (visible)
5. Renders children without wrapper when disabled -- render with disabled={true}, verify children exist, no tooltip wrapper div with onMouseEnter
6. Renders children without wrapper when content is empty/null -- render with content={null}
7. Shows tooltip with correct content text -- verify getByRole('tooltip').toHaveTextContent(expectedContent)
8. Supports ReactNode content (not just string) -- render with content={<span>Bold text</span>}
9. Supports all position variants (top, bottom, left, right) -- verify position CSS classes applied
10. Clears timeout on unmount (no memory leak) -- mouseEnter then unmount, no errors
11. Keyboard accessibility: shows on focus, hides on blur

Use `vi.useFakeTimers()` in beforeEach and `vi.useRealTimers()` in afterEach. Wrap timer advancement in `act()`.

**ColumnRow.test.tsx (ColumnRow with different node types):**
Must mock `@xyflow/react` Handle component: `vi.mock('@xyflow/react', () => ({ Handle: (props: any) => <div data-testid="handle" {...props} />, Position: { Left: 'left', Right: 'right' } }));`

Test cases:
1. Renders PK badge when column.isPrimaryKey is true -- expect screen.getByText('PK')
2. PK badge tooltip shows "Primary Key - uniquely identifies each row" on hover (use fake timers)
3. Renders FK badge when column.isForeignKey is true -- expect screen.getByText('FK')
4. FK badge tooltip shows "Foreign Key - references another table's primary key" on hover
5. Data type tooltip shows "Data type: {column.dataType}" on hover
6. Long column name (>=20 chars) shows tooltip with full name on hover
7. Short column name (<20 chars) does NOT show tooltip (disabled prop)
8. Renders with selected styling (bg-blue-100 class)
9. Renders with highlighted styling (bg-green-50 class)
10. Renders with dimmed styling (opacity-20 class)
11. Calls onClick with column.id when clicked
12. Click does not propagate (stopPropagation called)
  </action>
  <verify>
Run: `cd /Users/Daniel.Tehan/Code/lineage/lineage-ui && npx vitest run src/components/common/Tooltip.test.tsx src/components/domain/LineageGraph/TableNode/ColumnRow.test.tsx`
All tests pass. No test failures.
  </verify>
  <done>
Tooltip.test.tsx has 10+ tests covering show/hide/delay/disabled/position/keyboard behavior.
ColumnRow.test.tsx has 10+ tests covering PK/FK/dataType/longName tooltips and selection states.
All tests pass on first run.
  </done>
</task>

<task type="auto">
  <name>Task 2: useFitToSelection hook integration tests (TEST-02)</name>
  <files>
    lineage-ui/src/components/domain/LineageGraph/hooks/useFitToSelection.test.ts
  </files>
  <action>
Create `useFitToSelection.test.ts` following the EXACT pattern from `useSmartViewport.test.ts`:

**Mock setup (module level):**
```typescript
const mockFitView = vi.fn();
const mockGetNodes = vi.fn();

vi.mock('@xyflow/react', async () => {
  const actual = await vi.importActual('@xyflow/react');
  return {
    ...actual,
    useReactFlow: () => ({
      fitView: mockFitView,
      getNodes: mockGetNodes,
    }),
  };
});

vi.mock('../../../../stores/useLineageStore', () => ({
  useLineageStore: vi.fn(),
}));
```

Then import and vi.mocked the store for per-test control.

**Wrapper:** `const wrapper = ({ children }) => createElement(ReactFlowProvider, null, children);`

**Test cases:**
1. Returns fitToSelection function and hasSelection boolean
2. hasSelection is true when highlightedNodeIds has entries
3. hasSelection is false when highlightedNodeIds is empty Set
4. fitToSelection calls fitView with correct table node IDs -- setup: highlightedNodeIds = Set(['col-A', 'col-B']), getNodes returns 3 tableNode nodes where table-1 has col-A in columns, table-2 has col-B, table-3 has col-C. Assert fitView called with nodes: [{id: 'table-1'}, {id: 'table-2'}], padding: 0.15, duration: 300
5. fitToSelection does NOT call fitView when highlightedNodeIds is empty
6. fitToSelection does NOT call fitView when no table nodes contain highlighted columns (columns in highlight set but no matching tableNode data)
7. Handles single highlighted column correctly (one table node returned)
8. Handles all columns in same table (returns single table node, not duplicates)
9. Uses FIT_TO_SELECTION_PADDING = 0.15 (verify exact padding value)
10. Uses FIT_TO_SELECTION_DURATION = 300 (verify exact duration value)

Mock useLineageStore differently per test using mockUseLineageStore.mockImplementation((selector) => selector({ highlightedNodeIds: new Set([...]) })).

Each getNodes mock returns nodes with type: 'tableNode' and data: { columns: [{ id: '...' }] } matching the TableNodeData shape.
  </action>
  <verify>
Run: `cd /Users/Daniel.Tehan/Code/lineage/lineage-ui && npx vitest run src/components/domain/LineageGraph/hooks/useFitToSelection.test.ts`
All tests pass. No test failures.
  </verify>
  <done>
useFitToSelection.test.ts has 10 tests covering:
- hasSelection reflects highlightedNodeIds state
- fitToSelection correctly maps column IDs to parent table node IDs
- fitView called with exact padding (0.15) and duration (300)
- Edge cases: empty selection, no matching tables, single table, all-same-table
All tests pass on first run.
  </done>
</task>

</tasks>

<verification>
Run the complete test suite to ensure no regressions:
```bash
cd /Users/Daniel.Tehan/Code/lineage/lineage-ui && npx vitest run
```
All existing 260+ tests plus new tests pass. Zero failures.
</verification>

<success_criteria>
- TEST-01 satisfied: Tooltip.test.tsx + ColumnRow.test.tsx cover hover tooltip behavior for PK, FK, data type, and long column names
- TEST-02 satisfied: useFitToSelection.test.ts covers viewport calculation with mocked React Flow and Zustand store
- All new tests pass
- No existing tests broken
</success_criteria>

<output>
After completion, create `.planning/phases/23-testing-&-validation/23-01-SUMMARY.md`
</output>
